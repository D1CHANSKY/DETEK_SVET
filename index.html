<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ì—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å DTEK</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --tg-bg: var(--tg-theme-bg-color, #ffffff);
      --tg-text: var(--tg-theme-text-color, #1a1a1a);
      --tg-hint: var(--tg-theme-hint-color, #666666);
      --tg-link: var(--tg-theme-link-color, #2481cc);
      --tg-btn: var(--tg-theme-button-color, #2481cc);
      --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
      --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f1f1f1);
    }
    body {
      background-color: var(--tg-bg);
      color: var(--tg-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .tg-btn {
      background-color: var(--tg-btn);
      color: var(--tg-btn-text);
    }
    .tg-secondary { background-color: var(--tg-secondary-bg); }
    .tg-hint { color: var(--tg-hint); }
    .tg-link { color: var(--tg-link); }

    /* Timeline slots */
    .slot-power    { background: #ffffff; border: 1px solid #e5e7eb; }
    .slot-no_power { background: #6b7280; }
    .slot-possible { background: #d1d5db; }

    /* Big status indicator pulse */
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
      50%       { box-shadow: 0 0 0 16px rgba(34,197,94,0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50%       { box-shadow: 0 0 0 16px rgba(239,68,68,0); }
    }
    .status-on  { animation: pulse-green 2s infinite; }
    .status-off { animation: pulse-red 2s infinite; }

    .screen { display: none; }
    .screen.active { display: block; }

    input, select {
      background-color: var(--tg-secondary-bg);
      color: var(--tg-text);
      border: 1.5px solid transparent;
      transition: border-color .2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--tg-btn);
    }
    .nav-tab { transition: all .2s; }
    .nav-tab.active {
      color: var(--tg-btn);
      border-bottom: 2px solid var(--tg-btn);
    }
  </style>
</head>
<body class="min-h-screen pb-20">

<!-- ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav id="nav" class="fixed bottom-0 left-0 right-0 tg-secondary border-t border-gray-200 flex z-50" style="display:none!important">
  <button onclick="showScreen('dashboard')" class="nav-tab flex-1 py-3 text-center text-xs font-medium" id="tab-dashboard">
    <div class="text-lg">‚ö°</div>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
  </button>
  <button onclick="showScreen('schedule')" class="nav-tab flex-1 py-3 text-center text-xs font-medium" id="tab-schedule">
    <div class="text-lg">üìÖ</div>–ì—Ä–∞—Ñ—ñ–∫
  </button>
  <button onclick="showScreen('sensor')" class="nav-tab flex-1 py-3 text-center text-xs font-medium" id="tab-sensor">
    <div class="text-lg">üì±</div>–î–∞—Ç—á–∏–∫
  </button>
</nav>


<!-- ‚ïê‚ïê‚ïê SCREEN: REGISTRATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-registration" class="screen active px-4 py-6">
  <div class="text-center mb-8">
    <div class="text-5xl mb-3">‚ö°</div>
    <h1 class="text-2xl font-bold">–ì—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</h1>
    <p class="tg-hint text-sm mt-1">DTEK –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</p>
  </div>

  <div class="max-w-sm mx-auto space-y-4">
    <div>
      <label class="block text-sm font-medium mb-1">üèôÔ∏è –ú—ñ—Å—Ç–æ</label>
      <input id="reg-city" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤"
        class="w-full rounded-xl px-4 py-3 text-base"
        list="city-suggestions" />
      <datalist id="city-suggestions">
        <option value="–ö–∏—ó–≤" />
        <option value="–î–Ω—ñ–ø—Ä–æ" />
        <option value="–û–¥–µ—Å–∞" />
        <option value="–•–∞—Ä–∫—ñ–≤" />
        <option value="–ó–∞–ø–æ—Ä—ñ–∂–∂—è" />
        <option value="–ö—Ä–∏–≤–∏–π –†—ñ–≥" />
        <option value="–•–µ—Ä—Å–æ–Ω" />
        <option value="–ú–∏–∫–æ–ª–∞—ó–≤" />
      </datalist>
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">üõ£Ô∏è –í—É–ª–∏—Ü—è</label>
      <input id="reg-street" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫"
        class="w-full rounded-xl px-4 py-3 text-base" />
    </div>

    <div class="flex gap-3">
      <div class="flex-1">
        <label class="block text-sm font-medium mb-1">üè† –ë—É–¥–∏–Ω–æ–∫</label>
        <input id="reg-house" type="text" placeholder="1–ê"
          class="w-full rounded-xl px-4 py-3 text-base" />
      </div>
      <div class="flex-1">
        <label class="block text-sm font-medium mb-1">üë• –ì—Ä—É–ø–∞ DTEK</label>
        <select id="reg-group" class="w-full rounded-xl px-4 py-3 text-base">
          <option value="">–û–±–µ—Ä—ñ—Ç—å</option>
          <option value="1">–ì—Ä—É–ø–∞ 1</option>
          <option value="2">–ì—Ä—É–ø–∞ 2</option>
          <option value="3">–ì—Ä—É–ø–∞ 3</option>
          <option value="4">–ì—Ä—É–ø–∞ 4</option>
          <option value="5">–ì—Ä—É–ø–∞ 5</option>
          <option value="6">–ì—Ä—É–ø–∞ 6</option>
        </select>
      </div>
    </div>

    <div class="tg-secondary rounded-xl p-3 text-xs tg-hint">
      üí° <b>–Ø–∫ –¥—ñ–∑–Ω–∞—Ç–∏—Å—å —Å–≤–æ—é –≥—Ä—É–ø—É?</b><br>
      –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞ —Å–∞–π—Ç—ñ DTEK –∞–±–æ –Ω–∞ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –∑–∞ –∫–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏.
    </div>

    <button onclick="registerHouse()"
      class="tg-btn w-full py-4 rounded-2xl font-semibold text-base mt-2">
      –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å—É ‚Üí
    </button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SCREEN: DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-dashboard" class="screen px-4 py-4">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="font-bold text-lg">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω</h2>
      <p class="tg-hint text-xs" id="dash-address">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>
    <button onclick="refreshDashboard()" class="tg-hint text-2xl">‚Üª</button>
  </div>

  <!-- Big Live Status Indicator -->
  <div class="rounded-3xl p-6 mb-4 text-center" id="status-card"
    style="background: linear-gradient(135deg, #f0fdf4, #dcfce7)">
    <div id="status-circle"
      class="w-28 h-28 rounded-full mx-auto mb-4 flex items-center justify-center text-5xl status-on"
      style="background:#22c55e">
      üí°
    </div>
    <div id="status-label" class="text-2xl font-bold text-green-700">–°–≤—ñ—Ç–ª–æ —î</div>
    <div id="status-sublabel" class="text-sm mt-1 text-green-600">–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤ –Ω–æ—Ä–º—ñ</div>
  </div>

  <!-- Sensor & Schedule info row -->
  <div class="grid grid-cols-2 gap-3 mb-4">
    <div class="tg-secondary rounded-2xl p-3 text-center">
      <div class="text-2xl mb-1" id="sensor-icon">üì°</div>
      <div class="text-xs font-medium">–î–∞—Ç—á–∏–∫ –æ—Å–µ–ª—ñ</div>
      <div class="text-xs tg-hint mt-0.5" id="sensor-updated">‚Äî</div>
    </div>
    <div class="tg-secondary rounded-2xl p-3 text-center">
      <div class="text-2xl mb-1">üë•</div>
      <div class="text-xs font-medium" id="dash-group">–ì—Ä—É–ø–∞ ‚Äî</div>
      <div class="text-xs tg-hint mt-0.5">DTEK –≥—Ä–∞—Ñ—ñ–∫</div>
    </div>
  </div>

  <!-- Next event -->
  <div id="next-event-card" class="rounded-2xl p-4 mb-4 border-l-4 border-blue-400"
    style="background: rgba(59,130,246,0.05)">
    <div class="text-xs tg-hint font-medium mb-1">–ù–ê–°–¢–£–ü–ù–ê –ü–û–î–Ü–Ø</div>
    <div id="next-event-text" class="font-semibold">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    <div id="next-event-time" class="text-xs tg-hint mt-0.5"></div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SCREEN: SCHEDULE (24h timeline) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-schedule" class="screen px-4 py-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-bold text-lg">üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h2>
    <span class="tg-hint text-xs" id="sched-date"></span>
  </div>

  <div class="tg-secondary rounded-2xl p-3 mb-4">
    <div class="text-xs tg-hint mb-2 font-medium">–ì–†–£–ü–ê DTEK: <span id="sched-group">‚Äî</span></div>
    <!-- Legend -->
    <div class="flex gap-4 text-xs">
      <div class="flex items-center gap-1.5">
        <div class="w-3 h-3 rounded slot-power border"></div><span>–°–≤—ñ—Ç–ª–æ —î</span>
      </div>
      <div class="flex items-center gap-1.5">
        <div class="w-3 h-3 rounded slot-no_power"></div><span>–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</span>
      </div>
      <div class="flex items-center gap-1.5">
        <div class="w-3 h-3 rounded slot-possible"></div><span>–ú–æ–∂–ª–∏–≤–æ —î</span>
      </div>
    </div>
  </div>

  <!-- Timeline grid -->
  <div id="timeline-grid" class="grid gap-1 mb-4" style="grid-template-columns: repeat(12, 1fr)">
    <!-- filled by JS -->
  </div>

  <!-- Hourly list -->
  <div id="hourly-list" class="space-y-1">
    <!-- filled by JS -->
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SCREEN: SENSOR SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-sensor" class="screen px-4 py-4">
  <div class="text-center mb-6">
    <div class="text-5xl mb-2">üì±</div>
    <h2 class="text-xl font-bold">–î–∞—Ç—á–∏–∫ –æ—Å–µ–ª—ñ</h2>
    <p class="tg-hint text-sm mt-1">–°—Ç–∞—Ä–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω —è–∫ —Å–µ–Ω—Å–æ—Ä –∂–∏–≤–ª–µ–Ω–Ω—è</p>
  </div>

  <div class="space-y-3 mb-6">
    <div class="tg-secondary rounded-2xl p-4">
      <div class="font-medium mb-2">‚öôÔ∏è –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?</div>
      <p class="text-sm tg-hint leading-relaxed">
        –í—ñ–∑—å–º—ñ—Ç—å —Å—Ç–∞—Ä–∏–π Android-—Ç–µ–ª–µ—Ñ–æ–Ω, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å <b>Termux</b> —Ç–∞ –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç.
        –¢–µ–ª–µ—Ñ–æ–Ω —â–æ—Ö–≤–∏–ª–∏–Ω–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î ‚Äî —á–∏ —î –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è (220–í). –Ø–∫—â–æ —Å–≤—ñ—Ç–ª–æ –∑–Ω–∏–∫–ª–æ —á–∏ –∑'—è–≤–∏–ª–æ—Å—å ‚Äî
        –≤–∏ –æ–¥—Ä–∞–∑—É –æ—Ç—Ä–∏–º–∞—î—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.
      </p>
    </div>

    <div class="tg-secondary rounded-2xl p-4">
      <div class="font-medium mb-3">üìã –ö—Ä–æ–∫–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
      <div class="space-y-2 text-sm">
        <div class="flex gap-3 items-start">
          <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0 font-bold">1</span>
          <span>–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å <b>Termux</b> –∑ <a href="https://f-droid.org" class="tg-link">F-Droid</a></span>
        </div>
        <div class="flex gap-3 items-start">
          <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0 font-bold">2</span>
          <span>–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç–∏:<br><code class="text-xs bg-black/10 px-1 rounded">pkg install python termux-api</code></span>
        </div>
        <div class="flex gap-3 items-start">
          <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0 font-bold">3</span>
          <span>–û—Ç—Ä–∏–º–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂—á–µ —Ç–∞ –∑–∞–ø—É—Å—Ç—ñ—Ç—å:<br><code class="text-xs bg-black/10 px-1 rounded">python power_sensor.py</code></span>
        </div>
        <div class="flex gap-3 items-start">
          <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0 font-bold">4</span>
          <span>–ó–∞–ª–∏—à—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–º –¥–æ –∑–∞—Ä—è–¥–∫–∏ –≤–¥–æ–º–∞</span>
        </div>
      </div>
    </div>

    <!-- Current sensor status -->
    <div class="tg-secondary rounded-2xl p-4" id="sensor-status-card">
      <div class="font-medium mb-2">üì° –°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞</div>
      <div id="sensor-status-detail" class="text-sm tg-hint">–î–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</div>
    </div>
  </div>

  <button onclick="requestSensorScript()"
    class="tg-btn w-full py-4 rounded-2xl font-semibold text-base">
    üì• –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç —É Telegram
  </button>
</div>


<!-- ‚ïê‚ïê‚ïê LOADING OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading" class="fixed inset-0 flex items-center justify-center z-50"
  style="background: var(--tg-bg)">
  <div class="text-center">
    <div class="text-5xl mb-3 animate-bounce">‚ö°</div>
    <div class="font-medium">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>
</div>


<script>
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_BASE = window.location.origin.includes('localhost')
  ? 'http://localhost:8000/api'
  : '/api';

// ‚ïê‚ïê‚ïê TELEGRAM WEBAPP INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram?.WebApp;
let tgUser = null;

if (tg) {
  tg.ready();
  tg.expand();
  tgUser = tg.initDataUnsafe?.user;

  // Apply Telegram theme colors
  document.documentElement.style.setProperty('--tg-bg', tg.themeParams.bg_color || '#ffffff');
  document.documentElement.style.setProperty('--tg-text', tg.themeParams.text_color || '#1a1a1a');
  document.documentElement.style.setProperty('--tg-hint', tg.themeParams.hint_color || '#666666');
  document.documentElement.style.setProperty('--tg-link', tg.themeParams.link_color || '#2481cc');
  document.documentElement.style.setProperty('--tg-btn', tg.themeParams.button_color || '#2481cc');
  document.documentElement.style.setProperty('--tg-btn-text', tg.themeParams.button_text_color || '#ffffff');
  document.documentElement.style.setProperty('--tg-secondary-bg', tg.themeParams.secondary_bg_color || '#f1f1f1');
}

// ‚ïê‚ïê‚ïê APP STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let appState = {
  currentHouse: null,
  schedule: null,
};

// ‚ïê‚ïê‚ïê SCREEN MANAGEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`screen-${name}`)?.classList.add('active');
  document.getElementById(`tab-${name}`)?.classList.add('active');

  if (name === 'schedule') loadSchedule();
  if (name === 'dashboard') refreshDashboard();
  if (name === 'sensor') loadSensorStatus();
}

function showNav() {
  const nav = document.getElementById('nav');
  nav.style.display = 'flex';
  nav.style.setProperty('display', 'flex', 'important');
}

// ‚ïê‚ïê‚ïê INITIALIZATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  // Try to load existing house for user
  const savedHouse = localStorage.getItem('dtek_house');
  if (savedHouse) {
    appState.currentHouse = JSON.parse(savedHouse);
    showNav();
    showScreen('dashboard');
    hideLoading();
    return;
  }

  // If tgUser exists, check API
  if (tgUser) {
    try {
      const resp = await fetch(`${API_BASE}/houses/user/${tgUser.id}`);
      const data = await resp.json();
      if (data.houses && data.houses.length > 0) {
        appState.currentHouse = data.houses[0];
        localStorage.setItem('dtek_house', JSON.stringify(appState.currentHouse));
        showNav();
        showScreen('dashboard');
        hideLoading();
        return;
      }
    } catch (e) {
      console.log('API unavailable, using demo mode');
    }
  }

  // Show registration
  hideLoading();
  showScreen('registration');
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// ‚ïê‚ïê‚ïê REGISTRATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function registerHouse() {
  const city = document.getElementById('reg-city').value.trim();
  const street = document.getElementById('reg-street').value.trim();
  const house = document.getElementById('reg-house').value.trim();
  const group = document.getElementById('reg-group').value;

  if (!city || !street || !house || !group) {
    tg?.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è');
    return;
  }

  // Register user first
  if (tgUser) {
    try {
      await fetch(`${API_BASE}/users/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: tgUser.id,
          username: tgUser.username,
          first_name: tgUser.first_name,
        }),
      });

      const resp = await fetch(`${API_BASE}/houses/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          telegram_id: tgUser.id,
          city, street, house_number: house,
          dtek_group: parseInt(group),
        }),
      });
      const data = await resp.json();
      appState.currentHouse = data;
    } catch (e) {
      // Demo mode
      appState.currentHouse = { id: 1, city, street, house_number: house, dtek_group: parseInt(group) };
    }
  } else {
    // Demo/preview mode
    appState.currentHouse = { id: 1, city, street, house_number: house, dtek_group: parseInt(group) };
  }

  localStorage.setItem('dtek_house', JSON.stringify(appState.currentHouse));
  showNav();
  showScreen('dashboard');
}

// ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function refreshDashboard() {
  if (!appState.currentHouse) return;
  const h = appState.currentHouse;

  document.getElementById('dash-address').textContent =
    `${h.city}, ${h.street}, –±—É–¥. ${h.house_number}`;
  document.getElementById('dash-group').textContent = `–ì—Ä—É–ø–∞ ${h.dtek_group}`;

  try {
    const resp = await fetch(`${API_BASE}/schedule/${h.dtek_group}`);
    const data = await resp.json();
    appState.schedule = data;

    updateStatusCard(data.current_status);
    updateNextEvent(data.next_event);
  } catch (e) {
    // Use mock data
    updateStatusCard('power');
    updateNextEvent({ label: '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞', time: '15:00', in_hours: 3 });
  }

  // Update sensor info
  if (h.sensor_status) {
    const s = h.sensor_status;
    document.getElementById('sensor-icon').textContent = s.is_charging ? 'üü¢' : 'üî¥';
    document.getElementById('sensor-updated').textContent =
      s.updated_at ? `–û–Ω–æ–≤–ª–µ–Ω–æ: ${formatTime(s.updated_at)}` : '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö';
  }
}

function updateStatusCard(status) {
  const circle = document.getElementById('status-circle');
  const label = document.getElementById('status-label');
  const sublabel = document.getElementById('status-sublabel');
  const card = document.getElementById('status-card');

  if (status === 'power') {
    circle.style.background = '#22c55e';
    circle.className = circle.className.replace('status-off', 'status-on');
    circle.textContent = 'üí°';
    label.textContent = '–°–≤—ñ—Ç–ª–æ —î';
    label.className = 'text-2xl font-bold text-green-700';
    sublabel.textContent = '–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤ –Ω–æ—Ä–º—ñ';
    sublabel.className = 'text-sm mt-1 text-green-600';
    card.style.background = 'linear-gradient(135deg, #f0fdf4, #dcfce7)';
  } else {
    circle.style.background = '#ef4444';
    circle.className = circle.className.replace('status-on', 'status-off');
    circle.textContent = 'üî¥';
    label.textContent = '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
    label.className = 'text-2xl font-bold text-red-700';
    sublabel.textContent = '–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—î';
    sublabel.className = 'text-sm mt-1 text-red-500';
    card.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
  }
}

function updateNextEvent(event) {
  if (!event) {
    document.getElementById('next-event-text').textContent = '–î–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ';
    return;
  }
  document.getElementById('next-event-text').textContent = event.label;
  document.getElementById('next-event-time').textContent =
    `–û ${event.time} (—á–µ—Ä–µ–∑ ${event.in_hours} –≥–æ–¥.)`;
}

// ‚ïê‚ïê‚ïê SCHEDULE TIMELINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSchedule() {
  if (!appState.currentHouse) return;
  const group = appState.currentHouse.dtek_group;

  document.getElementById('sched-group').textContent = group;
  document.getElementById('sched-date').textContent = new Date().toLocaleDateString('uk-UA');

  let slots;
  try {
    const resp = await fetch(`${API_BASE}/schedule/${group}`);
    const data = await resp.json();
    slots = data.slots;
  } catch (e) {
    // Demo slots
    slots = generateDemoSlots(group);
  }

  renderTimeline(slots);
  renderHourlyList(slots);
}

function renderTimeline(slots) {
  const grid = document.getElementById('timeline-grid');
  const now = new Date().getHours();
  grid.innerHTML = '';

  slots.forEach(slot => {
    const div = document.createElement('div');
    div.className = `slot-${slot.type} rounded relative`;
    div.style.height = '32px';

    if (slot.hour === now) {
      div.style.outline = '2px solid var(--tg-btn)';
      div.style.outlineOffset = '1px';
    }

    const label = document.createElement('div');
    label.className = 'absolute bottom-0 left-0 right-0 text-center text-gray-500';
    label.style.fontSize = '8px';
    if (slot.hour % 3 === 0) {
      label.textContent = `${slot.hour}`;
    }
    div.appendChild(label);

    const tip = document.createElement('title');
    tip.textContent = `${slot.time_label}: ${slot.label}`;
    div.appendChild(tip);

    grid.appendChild(div);
  });
}

function renderHourlyList(slots) {
  const list = document.getElementById('hourly-list');
  const now = new Date().getHours();
  list.innerHTML = '';

  const icons = { power: 'üí°', no_power: '‚õî', possible: 'üîÜ' };
  const colors = { power: 'text-green-600', no_power: 'text-red-500', possible: 'text-yellow-500' };

  slots.forEach(slot => {
    const div = document.createElement('div');
    div.className = `flex items-center justify-between px-3 py-2 rounded-xl text-sm ${
      slot.hour === now ? 'border-2' : ''
    }`;
    div.style.borderColor = slot.hour === now ? 'var(--tg-btn)' : 'transparent';
    div.style.backgroundColor = slot.hour === now ? 'rgba(var(--tg-btn-rgb, 36,129,204), 0.05)' : 'var(--tg-secondary-bg)';

    div.innerHTML = `
      <span class="tg-hint w-16">${slot.time_label.split('‚Äì')[0]}</span>
      <span class="font-medium flex-1 ml-2 ${colors[slot.type]}">
        ${icons[slot.type]} ${slot.label}
      </span>
      ${slot.hour === now ? '<span class="text-xs tg-hint font-bold">‚Üê –∑–∞—Ä–∞–∑</span>' : ''}
    `;
    list.appendChild(div);
  });
}

function generateDemoSlots(group) {
  const schedules = {
    1:[1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0],
    2:[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,1],
    3:[1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0],
    4:[0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,0],
    5:[1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1],
    6:[0,0,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0,0],
  };
  const raw = schedules[group] || schedules[1];
  const types = { 1: 'power', 0: 'no_power' };
  const labels = { 1: '–°–≤—ñ—Ç–ª–æ —î', 0: '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è' };
  return raw.map((v, h) => ({
    hour: h,
    time_label: `${String(h).padStart(2,'0')}:00‚Äì${String((h+1)%24).padStart(2,'0')}:00`,
    type: types[v],
    label: labels[v],
  }));
}

// ‚ïê‚ïê‚ïê SENSOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSensorStatus() {
  const h = appState.currentHouse;
  if (!h) return;

  const detail = document.getElementById('sensor-status-detail');
  if (h.sensor_status) {
    const s = h.sensor_status;
    const statusText = s.is_charging ? 'üü¢ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ ‚Äî <b>–°–≤—ñ—Ç–ª–æ —î</b>' : 'üî¥ –í—ñ–¥–∫–ª—é—á–µ–Ω–æ ‚Äî <b>–ù–µ–º–∞—î —Å–≤—ñ—Ç–ª–∞</b>';
    const battery = s.battery_percentage ? `üîã –ê–∫—É–º—É–ª—è—Ç–æ—Ä: ${s.battery_percentage}%` : '';
    const updated = s.updated_at ? `‚è± –û–Ω–æ–≤–ª–µ–Ω–æ: ${formatTime(s.updated_at)}` : '';
    detail.innerHTML = `${statusText}<br>${battery}<br>${updated}`;
  } else {
    detail.textContent = '–î–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ. –û—Ç—Ä–∏–º–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂—á–µ.';
  }
}

async function requestSensorScript() {
  if (!tgUser && !appState.currentHouse) {
    tg?.showAlert('–°–ø–æ—á–∞—Ç–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å—É');
    return;
  }

  tg?.showAlert('–°–∫—Ä–∏–ø—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —É –≤–∞—à Telegram! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –±–æ—Ç–∞.');

  try {
    const tgId = tgUser?.id || 0;
    await fetch(`${API_BASE}/sensor/send-script/${tgId}`, { method: 'POST' });
  } catch (e) {
    console.log('API unavailable');
  }
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatTime(isoString) {
  try {
    return new Date(isoString).toLocaleTimeString('uk-UA', {
      hour: '2-digit', minute: '2-digit'
    });
  } catch { return '‚Äî'; }
}

// ‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  init();
});
</script>
</body>
</html>
