<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>–ì—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å DTEK</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg:   var(--tg-theme-bg-color,           #ffffff);
      --text: var(--tg-theme-text-color,         #111827);
      --hint: var(--tg-theme-hint-color,         #6b7280);
      --link: var(--tg-theme-link-color,         #2481cc);
      --btn:  var(--tg-theme-button-color,       #2481cc);
      --btnT: var(--tg-theme-button-text-color,  #ffffff);
      --sec:  var(--tg-theme-secondary_bg_color, #f3f4f6);
    }
    *    { box-sizing: border-box; }
    body { background:var(--bg); color:var(--text);
           font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
           -webkit-tap-highlight-color: transparent; }

    /* ‚îÄ‚îÄ TG helpers ‚îÄ‚îÄ */
    .tg-btn  { background:var(--btn); color:var(--btnT); }
    .tg-sec  { background:var(--sec); }
    .tg-hint { color:var(--hint); }
    .tg-link { color:var(--link); }

    /* ‚îÄ‚îÄ inputs ‚îÄ‚îÄ */
    input, select {
      background:var(--sec); color:var(--text);
      border:1.5px solid transparent; transition:border-color .18s;
      width:100%; border-radius:14px; padding:12px 16px; font-size:16px;
    }
    input:focus, select:focus { outline:none; border-color:var(--btn); }
    input::placeholder { color:var(--hint); }

    /* ‚îÄ‚îÄ screens ‚îÄ‚îÄ */
    .screen { display:none; }
    .screen.active { display:block; }

    /* ‚îÄ‚îÄ bottom nav ‚îÄ‚îÄ */
    .nav-tab { transition:all .18s; border-bottom:2px solid transparent; }
    .nav-tab.active { color:var(--btn); border-bottom-color:var(--btn); }

    /* ‚îÄ‚îÄ status pulses ‚îÄ‚îÄ */
    @keyframes pg { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)} 50%{box-shadow:0 0 0 20px rgba(34,197,94,0)} }
    @keyframes pr { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)} 50%{box-shadow:0 0 0 20px rgba(239,68,68,0)} }
    .pulse-g { animation:pg 2s infinite; }
    .pulse-r { animation:pr 2s infinite; }

    /* ‚îÄ‚îÄ timeline ‚îÄ‚îÄ */
    .slot-power    { background:#fff; border:1px solid #e5e7eb; }
    .slot-no_power { background:#6b7280; }
    .slot-possible { background:#d1d5db; }

    /* ‚îÄ‚îÄ autocomplete ‚îÄ‚îÄ */
    #street-dropdown {
      position:absolute; left:0; right:0; top:100%;
      background:var(--bg); border:1.5px solid var(--btn);
      border-radius:0 0 14px 14px; z-index:100;
      max-height:200px; overflow-y:auto;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
    }
    .autocomplete-item {
      padding:10px 16px; cursor:pointer; font-size:14px;
      border-bottom:1px solid var(--sec);
      transition:background .12s;
    }
    .autocomplete-item:hover { background:var(--sec); }
    .autocomplete-item:last-child { border-bottom:none; }

    /* ‚îÄ‚îÄ house-code badge ‚îÄ‚îÄ */
    .house-code {
      font-family:'Courier New',monospace; letter-spacing:.12em;
      background:linear-gradient(135deg,rgba(36,129,204,.1),rgba(36,129,204,.04));
      border:1.5px solid var(--btn); border-radius:10px;
    }

    /* ‚îÄ‚îÄ badge pills ‚îÄ‚îÄ */
    .badge-success { background:#dcfce7; color:#166534; }
    .badge-info    { background:#dbeafe; color:#1e40af; }
    .badge-warning { background:#fef3c7; color:#92400e; }

    /* ‚îÄ‚îÄ toast ‚îÄ‚îÄ */
    #toast {
      position:fixed; bottom:76px; left:50%; transform:translateX(-50%) translateY(12px);
      background:#111; color:#fff; padding:9px 18px; border-radius:20px;
      font-size:13px; opacity:0; transition:all .25s; z-index:999;
      pointer-events:none; white-space:nowrap;
    }
    #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ steps ‚îÄ‚îÄ */
    .step-num {
      min-width:24px; height:24px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:700;
    }

    /* ‚îÄ‚îÄ reg steps indicator ‚îÄ‚îÄ */
    .reg-step { display:none; }
    .reg-step.active { display:block; }
    .step-dot { width:8px; height:8px; border-radius:50%; background:var(--sec); transition:background .2s; }
    .step-dot.done { background:var(--btn); }
  </style>
</head>
<body class="min-h-screen pb-24">

<!-- ‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav id="nav" class="fixed bottom-0 left-0 right-0 tg-sec border-t border-gray-200/60 flex z-50"
     style="display:none!important">
  <button onclick="go('dashboard')" id="tab-dashboard"
    class="nav-tab flex-1 py-2 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">‚ö°</span>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
  </button>
  <button onclick="go('schedule')" id="tab-schedule"
    class="nav-tab flex-1 py-2 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">üìÖ</span>–ì—Ä–∞—Ñ—ñ–∫
  </button>
  <button onclick="go('sensor')" id="tab-sensor"
    class="nav-tab flex-1 py-2 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">üì±</span>–î–∞—Ç—á–∏–∫
  </button>
  <button onclick="go('settings')" id="tab-settings"
    class="nav-tab flex-1 py-2 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">‚öôÔ∏è</span>–ù–∞–ª–∞—à.
  </button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center z-50"
     style="background:var(--bg)">
  <div class="text-6xl mb-4 animate-bounce">‚ö°</div>
  <div class="font-semibold text-lg">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  <div class="tg-hint text-sm mt-1">DTEK –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: REGISTRATION  (3-–∫—Ä–æ–∫–æ–≤–∞ —Ñ–æ—Ä–º–∞)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-registration" class="screen active px-4 pt-6 pb-4">

  <!-- Header -->
  <div class="text-center mb-6">
    <div class="text-5xl mb-2">‚ö°</div>
    <h1 class="text-2xl font-bold">–ì—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</h1>
    <p class="tg-hint text-sm mt-1">DTEK –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</p>
  </div>

  <!-- Tab switch: New / Join -->
  <div class="flex tg-sec rounded-2xl p-1 mb-5 gap-1">
    <button id="rt-new"  onclick="switchRegTab('new')"
      class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all tg-btn">
      üè† –ù–æ–≤–∞ –∞–¥—Ä–µ—Å–∞
    </button>
    <button id="rt-join" onclick="switchRegTab('join')"
      class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all tg-hint">
      üîó –Ñ –∫–æ–¥ –±—É–¥–∏–Ω–∫—É
    </button>
  </div>

  <!-- ‚îÄ‚îÄ NEW ADDRESS: 3-step wizard ‚îÄ‚îÄ -->
  <div id="rf-new" class="max-w-sm mx-auto">

    <!-- Step dots -->
    <div class="flex justify-center gap-2 mb-5">
      <div class="step-dot done" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
    </div>

    <!-- STEP 1: City + Street + House -->
    <div id="reg-step-1" class="reg-step active space-y-3">
      <p class="text-sm font-semibold mb-3">–ö—Ä–æ–∫ 1 –∑ 3 ‚Äî –í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É</p>

      <!-- City with datalist -->
      <div>
        <label class="block text-xs font-semibold tg-hint uppercase tracking-wide mb-1">üèôÔ∏è –ú—ñ—Å—Ç–æ</label>
        <input id="reg-city" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤"
          list="cities-list" autocomplete="off"
          oninput="onCityInput()" />
        <datalist id="cities-list"></datalist>
      </div>

      <!-- Street with autocomplete dropdown -->
      <div class="relative">
        <label class="block text-xs font-semibold tg-hint uppercase tracking-wide mb-1">üõ£Ô∏è –í—É–ª–∏—Ü—è</label>
        <input id="reg-street" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –•—Ä–µ—â–∞—Ç–∏–∫"
          autocomplete="off"
          oninput="onStreetInput()" onfocus="onStreetInput()" />
        <div id="street-dropdown" class="hidden"></div>
      </div>

      <!-- House number -->
      <div>
        <label class="block text-xs font-semibold tg-hint uppercase tracking-wide mb-1">üè† –ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É</label>
        <input id="reg-house" type="text" placeholder="12–ê" autocomplete="off"/>
      </div>

      <button onclick="goStep2()"
        class="tg-btn w-full py-3.5 rounded-2xl font-bold text-base mt-2">
        –î–∞–ª—ñ ‚Üí –í–∏–∑–Ω–∞—á–∏—Ç–∏ –≥—Ä—É–ø—É
      </button>
    </div>

    <!-- STEP 2: Group lookup result + confirm -->
    <div id="reg-step-2" class="reg-step space-y-3">
      <button onclick="backStep1()" class="tg-hint text-sm mb-1">‚Üê –ù–∞–∑–∞–¥</button>
      <p class="text-sm font-semibold">–ö—Ä–æ–∫ 2 –∑ 3 ‚Äî –ì—Ä—É–ø–∞ DTEK</p>

      <!-- Lookup result card -->
      <div id="lookup-card" class="tg-sec rounded-2xl p-4">
        <div id="lookup-status" class="flex items-center gap-2 mb-2">
          <div class="w-5 h-5 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
          <span class="text-sm">–í–∏–∑–Ω–∞—á–∞—î–º–æ –≥—Ä—É–ø—É...</span>
        </div>
        <div id="lookup-address" class="text-xs tg-hint"></div>
      </div>

      <!-- Manual group select (shown if lookup failed) -->
      <div id="manual-group-wrap" class="hidden">
        <label class="block text-xs font-semibold tg-hint uppercase tracking-wide mb-1">
          üë• –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É –≤—Ä—É—á–Ω—É
        </label>
        <select id="reg-group">
          <option value="1">–ì—Ä—É–ø–∞ 1</option><option value="2">–ì—Ä—É–ø–∞ 2</option>
          <option value="3">–ì—Ä—É–ø–∞ 3</option><option value="4">–ì—Ä—É–ø–∞ 4</option>
          <option value="5">–ì—Ä—É–ø–∞ 5</option><option value="6">–ì—Ä—É–ø–∞ 6</option>
        </select>
        <p class="text-xs tg-hint mt-1">
          üí° –ì—Ä—É–ø—É –º–æ–∂–Ω–∞ –¥—ñ–∑–Ω–∞—Ç–∏—Å—å –Ω–∞ —Å–∞–π—Ç—ñ DTEK –∞–±–æ –≤ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó
        </p>
      </div>

      <!-- Mini schedule preview -->
      <div id="schedule-preview" class="hidden">
        <p class="text-xs tg-hint font-semibold uppercase tracking-wide mb-2">
          –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ —Ä–æ–∑–∫–ª–∞–¥—É
        </p>
        <div id="preview-timeline" class="grid gap-0.5 rounded-xl overflow-hidden mb-2"
          style="grid-template-columns:repeat(24,1fr)"></div>
        <div id="preview-status" class="text-sm font-semibold"></div>
      </div>

      <button id="step2-btn" onclick="goStep3()" disabled
        class="tg-btn w-full py-3.5 rounded-2xl font-bold text-base opacity-50">
        –î–∞–ª—ñ ‚Üí –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
      </button>
    </div>

    <!-- STEP 3: Confirm -->
    <div id="reg-step-3" class="reg-step space-y-3">
      <button onclick="backStep2()" class="tg-hint text-sm mb-1">‚Üê –ù–∞–∑–∞–¥</button>
      <p class="text-sm font-semibold">–ö—Ä–æ–∫ 3 –∑ 3 ‚Äî –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</p>

      <div class="tg-sec rounded-2xl p-4 space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="tg-hint">–ú—ñ—Å—Ç–æ</span>
          <span id="conf-city" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span class="tg-hint">–í—É–ª–∏—Ü—è</span>
          <span id="conf-street" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span class="tg-hint">–ë—É–¥–∏–Ω–æ–∫</span>
          <span id="conf-house" class="font-medium"></span>
        </div>
        <div class="flex justify-between">
          <span class="tg-hint">–ì—Ä—É–ø–∞ DTEK</span>
          <span id="conf-group" class="font-bold" style="color:var(--btn)"></span>
        </div>
      </div>

      <div id="conf-geo" class="hidden text-xs tg-hint p-3 tg-sec rounded-xl"></div>

      <button onclick="registerHouse()"
        class="tg-btn w-full py-4 rounded-2xl font-bold text-base">
        ‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –±—É–¥–∏–Ω–æ–∫
      </button>
    </div>
  </div><!-- /rf-new -->

  <!-- ‚îÄ‚îÄ JOIN HOUSE ‚îÄ‚îÄ -->
  <div id="rf-join" class="max-w-sm mx-auto space-y-4 hidden">
    <p class="tg-hint text-sm text-center">
      –í–≤–µ–¥—ñ—Ç—å 6-—Å–∏–º–≤–æ–ª—å–Ω–∏–π –∫–æ–¥, —è–∫–∏–º –ø–æ–¥—ñ–ª–∏–ª–∏—Å—å —Å—É—Å—ñ–¥–∏
    </p>
    <input id="join-code" type="text" placeholder="AB3X7K"
      maxlength="6" autocomplete="off"
      class="text-center text-2xl font-mono font-bold tracking-widest uppercase"
      style="letter-spacing:.2em"
      oninput="this.value=this.value.toUpperCase(); previewJoin(this.value)"/>

    <div id="join-preview" class="hidden tg-sec rounded-2xl p-4 text-sm space-y-1">
      <div class="font-semibold" id="jp-addr"></div>
      <div class="tg-hint text-xs" id="jp-group"></div>
      <div class="tg-hint text-xs" id="jp-neighbors"></div>
    </div>
    <div id="join-err" class="hidden text-center text-red-400 text-sm py-1"></div>

    <button onclick="joinHouseReg()"
      class="tg-btn w-full py-4 rounded-2xl font-bold text-base">
      üîó –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
    </button>
  </div>
</div><!-- /screen-registration -->


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: DASHBOARD
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-dashboard" class="screen px-4 py-4">

  <!-- Header -->
  <div class="flex items-start justify-between mb-4">
    <div class="flex-1 min-w-0">
      <h2 class="font-bold text-lg">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω</h2>
      <p class="tg-hint text-xs truncate" id="dash-address">‚Äî</p>
    </div>
    <div class="flex items-center gap-2 ml-2">
      <span id="dash-code" class="house-code text-xs font-bold px-2.5 py-1"></span>
      <button onclick="refreshDashboard()" class="tg-hint text-2xl leading-none">‚Üª</button>
    </div>
  </div>

  <!-- Big status card -->
  <div id="status-card" class="rounded-3xl p-6 mb-3 text-center transition-all duration-500"
    style="background:linear-gradient(135deg,#f0fdf4,#dcfce7)">
    <div id="status-circle"
      class="w-32 h-32 rounded-full mx-auto mb-4 flex items-center justify-center text-6xl pulse-g"
      style="background:#22c55e">üí°</div>
    <div id="status-label" class="text-2xl font-bold text-green-700">–°–≤—ñ—Ç–ª–æ —î</div>
    <div id="status-sub" class="text-sm mt-1 text-green-600">–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤ –Ω–æ—Ä–º—ñ</div>
  </div>

  <!-- Smart badge -->
  <div id="smart-badge" class="hidden text-center mb-3">
    <span id="smart-badge-text" class="inline-block text-xs font-semibold px-3 py-1 rounded-full badge-info"></span>
  </div>

  <!-- Info row -->
  <div class="grid grid-cols-3 gap-2 mb-3">
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5" id="dash-sensor-icon">‚ö™</div>
      <div class="text-xs font-semibold leading-tight" id="dash-sensor-label">–î–∞—Ç—á–∏–∫</div>
      <div class="text-xs tg-hint mt-0.5 leading-tight" id="dash-sensor-ago">‚Äî</div>
    </div>
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5">üë•</div>
      <div class="text-xs font-semibold" id="dash-group">–ì—Ä—É–ø–∞ ‚Äî</div>
      <div class="text-xs tg-hint mt-0.5" id="dash-neighbors">‚Äî –º–µ—à–∫.</div>
    </div>
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5">üîã</div>
      <div class="text-xs font-semibold" id="dash-battery">‚Äî%</div>
      <div class="text-xs tg-hint mt-0.5">–∞–∫—É–º—É–ª—è—Ç–æ—Ä</div>
    </div>
  </div>

  <!-- Next event -->
  <div class="rounded-2xl p-4 mb-3 border-l-4 border-blue-400"
    style="background:rgba(59,130,246,.05)">
    <div class="text-xs tg-hint font-semibold uppercase tracking-wide mb-1">–ù–∞—Å—Ç—É–ø–Ω–∞ –ø–æ–¥—ñ—è</div>
    <div id="next-event-text" class="font-semibold">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    <div id="next-event-time" class="text-xs tg-hint mt-0.5"></div>
  </div>

  <!-- Share -->
  <button onclick="shareCode()"
    class="w-full tg-sec rounded-2xl py-3 text-sm font-medium tg-link border border-blue-200/40">
    üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å –∫–æ–¥–æ–º –∑ —Å—É—Å—ñ–¥–∞–º–∏
  </button>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SCHEDULE
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-schedule" class="screen px-4 py-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-bold text-lg">üìÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h2>
    <span class="tg-hint text-xs" id="sched-date"></span>
  </div>

  <div class="tg-sec rounded-2xl p-3 mb-3">
    <div class="text-xs tg-hint font-semibold uppercase tracking-wide mb-2">
      –ì—Ä—É–ø–∞: <span id="sched-group" class="text-base font-bold" style="color:var(--text)">‚Äî</span>
    </div>
    <div class="flex gap-4 text-xs flex-wrap">
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-power border border-gray-200"></div>–°–≤—ñ—Ç–ª–æ —î</div>
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-no_power"></div>–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</div>
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-possible"></div>–ú–æ–∂–ª–∏–≤–æ —î</div>
    </div>
  </div>

  <div class="mb-1 flex justify-between text-xs tg-hint px-0.5">
    <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span>
  </div>
  <div id="sched-timeline" class="grid gap-0.5 mb-4 rounded-xl overflow-hidden"
    style="grid-template-columns:repeat(24,1fr)"></div>

  <div id="sched-list" class="space-y-1"></div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SENSOR
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-sensor" class="screen px-4 py-4">
  <div class="text-center mb-5">
    <div class="text-5xl mb-2">üì±</div>
    <h2 class="text-xl font-bold">–î–∞—Ç—á–∏–∫ –æ—Å–µ–ª—ñ</h2>
    <p class="tg-hint text-sm mt-1">–°—Ç–∞—Ä–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω —è–∫ —Å–µ–Ω—Å–æ—Ä –∂–∏–≤–ª–µ–Ω–Ω—è</p>
  </div>

  <!-- Current status -->
  <div id="sensor-status-card" class="tg-sec rounded-2xl p-4 mb-4">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">üì° –°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞</span>
      <span id="sensor-badge" class="text-xs px-2.5 py-1 rounded-full font-medium bg-gray-200 tg-hint">‚Äî</span>
    </div>
    <div id="sensor-detail" class="text-xs tg-hint space-y-0.5">
      <div>–î–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</div>
    </div>
  </div>

  <!-- House code -->
  <div class="tg-sec rounded-2xl p-4 mb-4">
    <div class="text-xs tg-hint font-semibold uppercase tracking-wide mb-2">–ö–æ–¥ –±—É–¥–∏–Ω–∫—É</div>
    <div class="flex items-center gap-3">
      <span id="sensor-code" class="house-code text-2xl font-bold px-4 py-2">‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî</span>
      <button onclick="copyCode()" class="tg-link text-sm font-semibold">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
    </div>
    <p class="text-xs tg-hint mt-2">–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–æ–º –∑ —Å—É—Å—ñ–¥–∞–º–∏ ‚Äî –≤–æ–Ω–∏ –º–æ–∂—É—Ç—å –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å</p>
  </div>

  <!-- Setup steps -->
  <div class="tg-sec rounded-2xl p-4 mb-4">
    <div class="font-semibold text-sm mb-3">üìã –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞</div>
    <div class="space-y-2.5 text-sm">
      <div class="flex gap-3 items-start">
        <span class="tg-btn step-num flex-shrink-0">1</span>
        <span>–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å <b>Termux</b> –∑ <span class="tg-link font-medium">F-Droid</span> (–Ω–µ –∑ Play Store!)</span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn step-num flex-shrink-0">2</span>
        <span>–í–∏–∫–æ–Ω–∞–π—Ç–µ —É Termux:<br>
          <code class="text-xs bg-black/10 px-1.5 py-0.5 rounded mt-1 inline-block">pkg install python termux-api</code>
        </span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn step-num flex-shrink-0">3</span>
        <span>–û—Ç—Ä–∏–º–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç ‚Äî –≤–∞—à House ID –≤–∂–µ –≤–ø–∏—Å–∞–Ω–æ!</span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn step-num flex-shrink-0">4</span>
        <span>–ó–∞–ª–∏—à—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–º –¥–æ –∑–∞—Ä—è–¥–∫–∏ –≤–¥–æ–º–∞ üîå</span>
      </div>
    </div>
  </div>

  <button onclick="requestScript()"
    class="tg-btn w-full py-4 rounded-2xl font-bold text-base">
    üì• –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç —É Telegram
  </button>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SETTINGS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-settings" class="screen px-4 py-4">
  <h2 class="font-bold text-lg mb-4">‚öôÔ∏è –ú–æ—ó –±—É–¥–∏–Ω–∫–∏</h2>
  <div id="settings-list" class="space-y-3 mb-5"></div>

  <div class="tg-sec rounded-2xl p-4">
    <div class="font-semibold text-sm mb-3">üîó –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å –∑–∞ –∫–æ–¥–æ–º</div>
    <div class="flex gap-2">
      <input id="settings-join" type="text" placeholder="AB3X7K" maxlength="6"
        autocomplete="off"
        class="flex-1 text-center font-mono font-bold text-lg tracking-widest uppercase"
        style="letter-spacing:.15em; border-radius:12px; padding:10px;"
        oninput="this.value=this.value.toUpperCase()"/>
      <button onclick="joinFromSettings()"
        class="tg-btn px-4 rounded-xl font-semibold text-sm">
        –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å
      </button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EDIT MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="edit-modal" class="fixed inset-0 z-40 hidden items-end justify-center"
     style="background:rgba(0,0,0,.45); display:none"
     onclick="closeModal(event)">
  <div class="w-full max-w-md rounded-t-3xl p-5 pb-8" style="background:var(--bg)">
    <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
    <h3 class="font-bold text-lg mb-4">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ—Å–µ–ª—é</h3>
    <input type="hidden" id="edit-id"/>
    <div class="space-y-3">
      <input id="edit-city"   type="text" placeholder="–ú—ñ—Å—Ç–æ"/>
      <input id="edit-street" type="text" placeholder="–í—É–ª–∏—Ü—è"/>
      <input id="edit-house"  type="text" placeholder="–ë—É–¥–∏–Ω–æ–∫"/>
      <select id="edit-group" style="border-radius:14px; padding:12px 16px">
        <option value="1">–ì—Ä—É–ø–∞ 1</option><option value="2">–ì—Ä—É–ø–∞ 2</option>
        <option value="3">–ì—Ä—É–ø–∞ 3</option><option value="4">–ì—Ä—É–ø–∞ 4</option>
        <option value="5">–ì—Ä—É–ø–∞ 5</option><option value="6">–ì—Ä—É–ø–∞ 6</option>
      </select>
    </div>
    <button onclick="saveEdit()"
      class="tg-btn w-full py-4 rounded-2xl font-bold text-base mt-4">
      üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
    </button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://localhost:8000/api' : '/api';

// ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const tg = window.Telegram?.WebApp;
let tgUser = null;
if (tg) {
  tg.ready(); tg.expand();
  tgUser = tg.initDataUnsafe?.user;
  const tp = tg.themeParams || {};
  const r = document.documentElement;
  if (tp.bg_color)             r.style.setProperty('--bg',   tp.bg_color);
  if (tp.text_color)           r.style.setProperty('--text', tp.text_color);
  if (tp.hint_color)           r.style.setProperty('--hint', tp.hint_color);
  if (tp.link_color)           r.style.setProperty('--link', tp.link_color);
  if (tp.button_color)         r.style.setProperty('--btn',  tp.button_color);
  if (tp.button_text_color)    r.style.setProperty('--btnT', tp.button_text_color);
  if (tp.secondary_bg_color)   r.style.setProperty('--sec',  tp.secondary_bg_color);
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let S = {
  house:     null,
  allHouses: [],
  schedule:  null,
  // reg wizard
  regCity: '', regStreet: '', regHouse: '', regGroup: null, regGeo: null,
};

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, opts = {}) {
  const r = await fetch(API + path, {
    headers: {'Content-Type': 'application/json'}, ...opts
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.detail || r.statusText); }
  return r.json();
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _tt;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(() => el.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ ROUTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + screen)?.classList.add('active');
  document.getElementById('tab-' + screen)?.classList.add('active');
  const actions = { dashboard: refreshDashboard, schedule: loadSchedule,
                    sensor: loadSensorScreen, settings: loadSettings };
  actions[screen]?.();
}
function showNav() {
  const n = document.getElementById('nav');
  n.style.cssText = 'display:flex!important';
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  // Load cities for datalist
  api('/address/cities').then(d => {
    const dl = document.getElementById('cities-list');
    dl.innerHTML = d.cities.map(c => `<option value="${c}"/>`).join('');
  }).catch(() => {});

  const saved = localStorage.getItem('dtek_v3');
  if (saved) {
    S.house = JSON.parse(saved);
    showNav(); go('dashboard'); hideLoading(); return;
  }
  if (tgUser) {
    try {
      const r = await api(`/houses/user/${tgUser.id}`);
      if (r?.houses?.length) {
        S.house = r.houses[0]; S.allHouses = r.houses;
        save(); showNav(); go('dashboard'); hideLoading(); return;
      }
    } catch(_) {}
  }
  hideLoading();
  document.getElementById('screen-registration').classList.add('active');
}
function hideLoading() { document.getElementById('loading').style.display = 'none'; }
function save() { if (S.house) localStorage.setItem('dtek_v3', JSON.stringify(S.house)); }


// ‚ïê‚ïê‚ïê‚ïê REGISTRATION WIZARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchRegTab(tab) {
  const isNew = tab === 'new';
  document.getElementById('rf-new').classList.toggle('hidden', !isNew);
  document.getElementById('rf-join').classList.toggle('hidden', isNew);
  const tn = document.getElementById('rt-new');
  const tj = document.getElementById('rt-join');
  tn.className = tn.className.replace(isNew ? 'tg-hint' : 'tg-btn', isNew ? 'tg-btn' : 'tg-hint');
  tj.className = tj.className.replace(isNew ? 'tg-btn' : 'tg-hint', isNew ? 'tg-hint' : 'tg-btn');
}

function setDot(n) {
  [1,2,3].forEach(i => {
    document.getElementById('dot-'+i).classList.toggle('done', i <= n);
  });
}

function showRegStep(n) {
  document.querySelectorAll('.reg-step').forEach(s => s.classList.remove('active'));
  document.getElementById('reg-step-'+n)?.classList.add('active');
  setDot(n);
}

// ‚îÄ City input: refresh street autocomplete if city changes
function onCityInput() {
  document.getElementById('street-dropdown').classList.add('hidden');
  document.getElementById('street-dropdown').innerHTML = '';
}

// ‚îÄ Street autocomplete
let _streetTimer;
async function onStreetInput() {
  clearTimeout(_streetTimer);
  const city   = document.getElementById('reg-city').value.trim();
  const query  = document.getElementById('reg-street').value.trim();
  const dd     = document.getElementById('street-dropdown');

  if (!city || query.length < 2) { dd.classList.add('hidden'); return; }

  _streetTimer = setTimeout(async () => {
    try {
      const r = await api(`/address/streets?city=${encodeURIComponent(city)}&query=${encodeURIComponent(query)}`);
      if (r.streets.length === 0) { dd.classList.add('hidden'); return; }
      dd.innerHTML = r.streets.map(s =>
        `<div class="autocomplete-item" onclick="selectStreet('${s.replace(/'/g,"\\'")}')">üõ£Ô∏è ${s}</div>`
      ).join('');
      dd.classList.remove('hidden');
    } catch(_) { dd.classList.add('hidden'); }
  }, 350);
}

function selectStreet(name) {
  document.getElementById('reg-street').value = name;
  document.getElementById('street-dropdown').classList.add('hidden');
}

// Close dropdown when clicking elsewhere
document.addEventListener('click', e => {
  if (!e.target.closest('.relative'))
    document.getElementById('street-dropdown')?.classList.add('hidden');
});

// ‚îÄ Step 1 ‚Üí 2
async function goStep2() {
  const city   = document.getElementById('reg-city').value.trim();
  const street = document.getElementById('reg-street').value.trim();
  const house  = document.getElementById('reg-house').value.trim();
  if (!city || !street || !house) { toast('‚ö†Ô∏è –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }

  S.regCity = city; S.regStreet = street; S.regHouse = house;
  showRegStep(2);

  // Lookup
  const lookupCard = document.getElementById('lookup-card');
  const lookupSt   = document.getElementById('lookup-status');
  const lookupAddr = document.getElementById('lookup-address');
  const manualWrap = document.getElementById('manual-group-wrap');
  const schedPrev  = document.getElementById('schedule-preview');
  const step2btn   = document.getElementById('step2-btn');

  lookupAddr.textContent = `${city}, ${street}, ${house}`;
  step2btn.disabled = true;
  step2btn.classList.add('opacity-50');
  manualWrap.classList.add('hidden');
  schedPrev.classList.add('hidden');

  try {
    const r = await api('/address/lookup', {
      method: 'POST',
      body: JSON.stringify({ city, street, house_number: house }),
    });

    S.regGroup = r.group;
    S.regGeo   = r.geo;

    if (r.group) {
      const src = r.source === 'table' ? 'üìã –¢–∞–±–ª–∏—Ü—è DTEK' : 'üåê –ì–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è';
      const conf = r.confidence === 'high' ? 'üü¢ –í–∏—Å–æ–∫–∞' : 'üü° –°–µ—Ä–µ–¥–Ω—è';
      lookupSt.innerHTML = `
        <span class="text-green-600 font-semibold">‚úÖ –ì—Ä—É–ø—É –≤–∏–∑–Ω–∞—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</span>`;
      lookupCard.innerHTML = `
        <div class="text-sm font-bold mb-1">–ì—Ä—É–ø–∞ DTEK: <span style="color:var(--btn)">${r.group}</span></div>
        <div class="text-xs tg-hint">${src} ¬∑ –¢–æ—á–Ω—ñ—Å—Ç—å: ${conf}</div>
        <div class="text-xs tg-hint mt-0.5">${city}, ${street}, ${house}</div>
        <div class="text-xs tg-hint mt-0.5 italic">${r.message}</div>`;

      // Preview schedule
      if (r.schedule) {
        renderPreviewTimeline(r.schedule.slots);
        const cur = r.schedule.current_status === 'power' ? 'üí° –ó–∞—Ä–∞–∑: –°–≤—ñ—Ç–ª–æ —î' : 'üî¥ –ó–∞—Ä–∞–∑: –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
        document.getElementById('preview-status').textContent = cur;
        schedPrev.classList.remove('hidden');
      }
    } else {
      lookupSt.innerHTML = `<span class="text-yellow-600 font-semibold">‚ö†Ô∏è ${r.message}</span>`;
      lookupCard.innerHTML = `
        <div class="text-xs tg-hint">${r.message}</div>
        <div class="text-xs tg-hint mt-0.5">${city}, ${street}, ${house}</div>`;
      manualWrap.classList.remove('hidden');
      S.regGroup = parseInt(document.getElementById('reg-group').value);
    }

    step2btn.disabled = false;
    step2btn.classList.remove('opacity-50');
  } catch(e) {
    lookupSt.innerHTML = `<span class="text-red-500">‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.message}</span>`;
    manualWrap.classList.remove('hidden');
    S.regGroup = parseInt(document.getElementById('reg-group').value);
    step2btn.disabled = false;
    step2btn.classList.remove('opacity-50');
  }
}

function renderPreviewTimeline(slots) {
  const now = new Date().getHours();
  document.getElementById('preview-timeline').innerHTML = slots.map(s => `
    <div class="slot-${s.type}" style="height:20px;${s.hour===now?'outline:2px solid var(--btn);outline-offset:1px':''}"
      title="${s.time_label}: ${s.label}"></div>`).join('');
}

function backStep1() { showRegStep(1); }

function goStep3() {
  // If manual group selected
  if (document.getElementById('manual-group-wrap')?.classList.contains('hidden') === false) {
    S.regGroup = parseInt(document.getElementById('reg-group').value);
  }
  if (!S.regGroup) { toast('‚ö†Ô∏è –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É'); return; }

  document.getElementById('conf-city').textContent   = S.regCity;
  document.getElementById('conf-street').textContent = S.regStreet;
  document.getElementById('conf-house').textContent  = S.regHouse;
  document.getElementById('conf-group').textContent  = `–ì—Ä—É–ø–∞ ${S.regGroup}`;

  const geo = document.getElementById('conf-geo');
  if (S.regGeo?.display) {
    geo.textContent = `üìç ${S.regGeo.display.split(',').slice(0,3).join(',')}`;
    geo.classList.remove('hidden');
  } else {
    geo.classList.add('hidden');
  }

  showRegStep(3);
}

function backStep2() { showRegStep(2); }

async function registerHouse() {
  if (tgUser) {
    await api('/users/register', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name,
    })}).catch(() => {});
  }
  try {
    const data = await api('/houses/add', { method:'POST', body: JSON.stringify({
      telegram_id:  tgUser?.id || 0,
      city:         S.regCity,
      street:       S.regStreet,
      house_number: S.regHouse,
      dtek_group:   S.regGroup,
    })});
    S.house = data; save();
  } catch(_) {
    // Demo mode
    S.house = { id:1, house_code:'DEMO01', city: S.regCity, street: S.regStreet,
                house_number: S.regHouse, dtek_group: S.regGroup || 1, neighbors_count:1 };
    save();
  }
  showNav(); go('dashboard');
}

// ‚îÄ Join house (from reg screen)
let _joinTimer;
async function previewJoin(code) {
  clearTimeout(_joinTimer);
  document.getElementById('join-preview').classList.add('hidden');
  document.getElementById('join-err').classList.add('hidden');
  if (code.length !== 6) return;
  _joinTimer = setTimeout(async () => {
    try {
      const d = await api(`/houses/code/${code}`);
      document.getElementById('jp-addr').textContent = `${d.city}, ${d.street}, ${d.house_number}`;
      document.getElementById('jp-group').textContent = `–ì—Ä—É–ø–∞ DTEK: ${d.dtek_group}`;
      document.getElementById('jp-neighbors').textContent = `üë§ ${d.neighbors_count} –º–µ—à–∫–∞–Ω—Ü—ñ–≤ —Å—Ç–µ–∂–∞—Ç—å`;
      document.getElementById('join-preview').classList.remove('hidden');
    } catch(e) {
      document.getElementById('join-err').textContent = `‚ùå ${e.message}`;
      document.getElementById('join-err').classList.remove('hidden');
    }
  }, 400);
}

async function joinHouseReg() {
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (code.length !== 6) { toast('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å 6 —Å–∏–º–≤–æ–ª—ñ–≤'); return; }
  if (tgUser) {
    await api('/users/register', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name,
    })}).catch(() => {});
  }
  try {
    const d = await api('/houses/join', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser?.id || 0, house_code: code,
    })});
    S.house = d; save();
    toast(d.already_joined ? '‚ÑπÔ∏è –í–∂–µ –ø—Ä–∏—î–¥–Ω–∞–Ω–æ' : '‚úÖ –£—Å–ø—ñ—à–Ω–æ –ø—Ä–∏—î–¥–Ω–∞–Ω–æ!');
    showNav(); go('dashboard');
  } catch(e) { toast('‚ùå ' + e.message); }
}


// ‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function refreshDashboard() {
  if (!S.house) return;
  const h = S.house;
  document.getElementById('dash-address').textContent =
    `${h.city}, ${h.street}, ${h.house_number}`;
  document.getElementById('dash-code').textContent = h.house_code || '';
  document.getElementById('dash-group').textContent = `–ì—Ä—É–ø–∞ ${h.dtek_group}`;

  // Refresh from API
  if (tgUser || h.id) {
    try {
      const fresh = await api(`/status/${h.id}`);
      S.house = fresh; save();
      applyDashboard(fresh);
      return;
    } catch(_) {}
  }
  // Fallback: schedule only
  try {
    const sched = await api(`/schedule/${h.dtek_group}`);
    applyScheduleToStatus(sched);
  } catch(_) {}
}

function applyDashboard(h) {
  document.getElementById('dash-address').textContent = `${h.city}, ${h.street}, ${h.house_number}`;
  document.getElementById('dash-code').textContent    = h.house_code || '';
  document.getElementById('dash-group').textContent   = `–ì—Ä—É–ø–∞ ${h.dtek_group}`;
  document.getElementById('dash-neighbors').textContent = `${h.neighbors_count ?? '‚Äî'} –º–µ—à–∫.`;

  const smart = h.smart_status;
  if (smart) {
    renderStatusCard(smart.is_on);
    renderSmartBadge(smart);
    document.getElementById('next-event-text').textContent = '';
  }

  const sensor = h.sensor_status;
  if (sensor) {
    document.getElementById('dash-sensor-icon').textContent  = sensor.online ? (sensor.is_charging ? 'üü¢' : 'üî¥') : '‚ö™';
    document.getElementById('dash-sensor-label').textContent = sensor.online ? '–ê–∫—Ç–∏–≤–Ω–∏–π' : '–û—Ñ–ª–∞–π–Ω';
    document.getElementById('dash-sensor-ago').textContent   = sensor.minutes_ago != null ? `${sensor.minutes_ago} —Ö–≤ —Ç–æ–º—É` : '‚Äî';
    document.getElementById('dash-battery').textContent      = sensor.battery_percentage != null ? `${sensor.battery_percentage}%` : '‚Äî%';
  }

  // Also load schedule for next-event
  api(`/schedule/${h.dtek_group}`).then(sched => {
    S.schedule = sched;
    if (sched.next_event) {
      const ev = sched.next_event;
      document.getElementById('next-event-text').textContent = ev.label;
      document.getElementById('next-event-time').textContent = `–û ${ev.time} (—á–µ—Ä–µ–∑ ${ev.in_hours} –≥–æ–¥.)`;
    }
  }).catch(() => {});
}

function renderStatusCard(isOn) {
  const circle = document.getElementById('status-circle');
  const label  = document.getElementById('status-label');
  const sub    = document.getElementById('status-sub');
  const card   = document.getElementById('status-card');
  if (isOn) {
    circle.style.background = '#22c55e';
    circle.className = circle.className.replace('pulse-r','pulse-g');
    circle.textContent = 'üí°';
    label.textContent = '–°–≤—ñ—Ç–ª–æ —î'; label.className = 'text-2xl font-bold text-green-700';
    sub.textContent = '–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤ –Ω–æ—Ä–º—ñ'; sub.className = 'text-sm mt-1 text-green-600';
    card.style.background = 'linear-gradient(135deg,#f0fdf4,#dcfce7)';
  } else {
    circle.style.background = '#ef4444';
    circle.className = circle.className.replace('pulse-g','pulse-r');
    circle.textContent = 'üî¥';
    label.textContent = '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è'; label.className = 'text-2xl font-bold text-red-700';
    sub.textContent = '–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—î'; sub.className = 'text-sm mt-1 text-red-500';
    card.style.background = 'linear-gradient(135deg,#fef2f2,#fee2e2)';
  }
}

function renderSmartBadge(smart) {
  const wrap = document.getElementById('smart-badge');
  const text = document.getElementById('smart-badge-text');
  if (!smart?.badge) { wrap.classList.add('hidden'); return; }
  text.textContent = smart.badge;
  text.className = `inline-block text-xs font-semibold px-3 py-1 rounded-full badge-${smart.badge_type || 'info'}`;
  wrap.classList.remove('hidden');
}

function applyScheduleToStatus(sched) {
  const isOn = sched.current_status === 'power';
  renderStatusCard(isOn);
  if (sched.next_event) {
    const ev = sched.next_event;
    document.getElementById('next-event-text').textContent = ev.label;
    document.getElementById('next-event-time').textContent = `–û ${ev.time} (—á–µ—Ä–µ–∑ ${ev.in_hours} –≥–æ–¥.)`;
  }
}

function shareCode() {
  const code = S.house?.house_code;
  if (!code) return;
  const msg = `üè† –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å DTEK\n–ö–æ–¥ –±—É–¥–∏–Ω–∫—É: ${code}\n–ü—Ä–∏—î–¥–Ω—É–π—Å—è: @dtek_monitor_bot`;
  if (tg?.shareUrl) tg.shareUrl(msg);
  else { navigator.clipboard?.writeText(code); toast('üìã –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: ' + code); }
}


// ‚ïê‚ïê‚ïê‚ïê SCHEDULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadSchedule() {
  if (!S.house) return;
  const group = S.house.dtek_group;
  document.getElementById('sched-group').textContent = group;
  document.getElementById('sched-date').textContent =
    new Date().toLocaleDateString('uk-UA', {weekday:'short',day:'numeric',month:'short'});

  let slots;
  try {
    const r = await api(`/schedule/${group}`);
    S.schedule = r; slots = r.slots;
  } catch(_) { slots = mockSlots(group); }

  const now = new Date().getHours();
  document.getElementById('sched-timeline').innerHTML = slots.map(s => `
    <div class="slot-${s.type}" style="height:32px;${s.hour===now?'outline:2px solid var(--btn);outline-offset:1px':''}"
      title="${s.time_label}: ${s.label}"></div>`).join('');

  const icons = {power:'üí°',no_power:'‚õî',possible:'üîÜ'};
  const colors = {power:'text-green-600',no_power:'text-red-500',possible:'text-yellow-600'};
  document.getElementById('sched-list').innerHTML = slots.map(s => `
    <div class="flex items-center gap-2 px-3 py-2 rounded-xl text-sm
      ${s.hour===now ? 'border-2 font-semibold' : 'tg-sec'}"
      style="${s.hour===now ? 'border-color:var(--btn)' : ''}">
      <span class="tg-hint w-14 text-xs">${s.time_label.split('‚Äì')[0]}</span>
      <span class="${colors[s.type]} flex-1">${icons[s.type]} ${s.label}</span>
      ${s.hour===now ? '<span class="text-xs tg-hint font-normal">‚Üê –∑–∞—Ä–∞–∑</span>' : ''}
    </div>`).join('');
}

function mockSlots(g) {
  const raw = {1:[1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0],
    2:[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,1],
    3:[1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0],
    4:[0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,0],
    5:[1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1],
    6:[0,0,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0,0]}[g]||[];
  return raw.map((v,h)=>({
    hour:h, time_label:`${String(h).padStart(2,'0')}:00‚Äì${String((h+1)%24).padStart(2,'0')}:00`,
    type:v?'power':'no_power', label:v?'–°–≤—ñ—Ç–ª–æ —î':'–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è'
  }));
}


// ‚ïê‚ïê‚ïê‚ïê SENSOR SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadSensorScreen() {
  const h = S.house;
  if (!h) return;
  document.getElementById('sensor-code').textContent = h.house_code || '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî';

  const sensor = h.sensor_status;
  const badge  = document.getElementById('sensor-badge');
  const detail = document.getElementById('sensor-detail');

  if (!sensor) {
    badge.textContent = '–ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    badge.className = 'text-xs px-2.5 py-1 rounded-full font-medium bg-gray-200 tg-hint';
    detail.innerHTML = '<div>–î–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ. –û—Ç—Ä–∏–º–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∏–∂—á–µ.</div>';
    return;
  }

  const online   = sensor.online;
  const charging = sensor.is_charging;
  badge.textContent = sensor.online_label;
  badge.className = `text-xs px-2.5 py-1 rounded-full font-medium ${
    online ? (charging ? 'badge-success' : 'bg-red-100 text-red-700') : 'bg-gray-200 tg-hint'}`;

  const ago = sensor.minutes_ago != null ? ` ¬∑ ${sensor.minutes_ago} —Ö–≤ —Ç–æ–º—É` : '';
  detail.innerHTML = `
    <div>${charging ? 'üí° –ó–∞—Ä—è–¥–∂–∞—î—Ç—å—Å—è ‚Äî <b>–°–≤—ñ—Ç–ª–æ —î</b>' : 'üî¥ –í—ñ–¥ –±–∞—Ç–∞—Ä–µ—ó ‚Äî <b>–ù–µ–º–∞—î —Å–≤—ñ—Ç–ª–∞</b>'}</div>
    ${sensor.battery_percentage != null ? `<div>üîã –ê–∫—É–º—É–ª—è—Ç–æ—Ä: ${sensor.battery_percentage}%</div>` : ''}
    <div>‚è± –û–Ω–æ–≤–ª–µ–Ω–æ${ago}</div>`;
}

function copyCode() {
  const code = S.house?.house_code;
  if (!code) return;
  navigator.clipboard?.writeText(code).then(() => toast('üìã –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: ' + code));
}

async function requestScript() {
  if (!S.house) { toast('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ –±—É–¥–∏–Ω–æ–∫'); return; }
  toast('üì§ –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–∫—Ä–∏–ø—Ç...');
  try {
    await api(`/sensor/send-script/${tgUser?.id||0}?house_id=${S.house.id}`, {method:'POST'});
    toast('‚úÖ –°–∫—Ä–∏–ø—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —É Telegram!');
  } catch(_) { toast('‚ùå –ü–æ–º–∏–ª–∫–∞. –ù–∞–ø–∏—à—ñ—Ç—å –±–æ—Ç—É /sensor'); }
}


// ‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadSettings() {
  if (tgUser) {
    try {
      const r = await api(`/houses/user/${tgUser.id}`);
      if (r?.houses) { S.allHouses = r.houses; }
    } catch(_) {}
  }
  const houses = S.allHouses.length ? S.allHouses : (S.house ? [S.house] : []);
  document.getElementById('settings-list').innerHTML = houses.map(h => {
    const s = h.sensor_status;
    const si = s ? (s.online ? (s.is_charging?'üü¢':'üî¥') : '‚ö™') : '‚ö™';
    const sl = s ? s.online_label : '–î–∞—Ç—á–∏–∫ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    return `
    <div class="tg-sec rounded-2xl p-4">
      <div class="flex items-start justify-between mb-2">
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-sm">${h.city}, ${h.street}, ${h.house_number}</div>
          <div class="tg-hint text-xs mt-0.5">–ì—Ä—É–ø–∞ ${h.dtek_group} ¬∑ üë§ ${h.neighbors_count} –º–µ—à–∫.</div>
        </div>
        <button onclick='openModal(${JSON.stringify(h)})' class="tg-link text-sm font-semibold ml-2">‚úèÔ∏è</button>
      </div>
      <div class="flex items-center gap-3">
        <span class="house-code text-sm font-bold px-2 py-0.5">${h.house_code}</span>
        <span class="text-xs tg-hint">${si} ${sl}</span>
      </div>
    </div>`;
  }).join('') || '<p class="tg-hint text-sm text-center py-6">–ù–µ–º–∞—î –±—É–¥–∏–Ω–∫—ñ–≤</p>';
}

async function joinFromSettings() {
  const code = document.getElementById('settings-join').value.trim().toUpperCase();
  if (code.length !== 6) { toast('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å 6 —Å–∏–º–≤–æ–ª—ñ–≤'); return; }
  try {
    const d = await api('/houses/join', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser?.id||0, house_code: code,
    })});
    toast(d.already_joined ? '‚ÑπÔ∏è –í–∂–µ –ø—Ä–∏—î–¥–Ω–∞–Ω–æ' : `‚úÖ –ü—Ä–∏—î–¥–Ω–∞–Ω–æ –¥–æ ${d.city}`);
    S.house = d; save();
    document.getElementById('settings-join').value = '';
    loadSettings();
  } catch(e) { toast('‚ùå ' + e.message); }
}

// ‚îÄ‚îÄ Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(h) {
  document.getElementById('edit-id').value     = h.id;
  document.getElementById('edit-city').value   = h.city;
  document.getElementById('edit-street').value = h.street;
  document.getElementById('edit-house').value  = h.house_number;
  document.getElementById('edit-group').value  = h.dtek_group;
  const m = document.getElementById('edit-modal');
  m.style.display = 'flex';
}
function closeModal(e) {
  if (e.target === document.getElementById('edit-modal'))
    document.getElementById('edit-modal').style.display = 'none';
}
async function saveEdit() {
  const id   = parseInt(document.getElementById('edit-id').value);
  const body = {
    telegram_id:  tgUser?.id || 0, house_id: id,
    city:         document.getElementById('edit-city').value.trim(),
    street:       document.getElementById('edit-street').value.trim(),
    house_number: document.getElementById('edit-house').value.trim(),
    dtek_group:   parseInt(document.getElementById('edit-group').value),
  };
  try {
    const d = await api('/houses/edit', { method:'PATCH', body: JSON.stringify(body) });
    toast('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ');
    if (S.house?.id === id) { S.house = d; save(); }
    S.allHouses = S.allHouses.map(h => h.id === id ? d : h);
    document.getElementById('edit-modal').style.display = 'none';
    loadSettings();
  } catch(e) { toast('‚ùå ' + e.message); }
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
