<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ğ“Ñ€Ğ°Ñ„Ñ–ĞºĞ¸ Ğ²Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ÑŒ DTEK</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg:    var(--tg-theme-bg-color,            #ffffff);
      --text:  var(--tg-theme-text-color,          #1a1a1a);
      --hint:  var(--tg-theme-hint-color,          #666666);
      --link:  var(--tg-theme-link-color,          #2481cc);
      --btn:   var(--tg-theme-button-color,        #2481cc);
      --btnT:  var(--tg-theme-button-text-color,   #ffffff);
      --sec:   var(--tg-theme-secondary_bg_color,  #f1f1f1);
    }
    body { background:var(--bg); color:var(--text);
           font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; }
    .tg-btn  { background:var(--btn); color:var(--btnT); }
    .tg-sec  { background:var(--sec); }
    .tg-hint { color:var(--hint); }
    .tg-link { color:var(--link); }
    .tg-border { border-color: var(--btn); }

    input,select {
      background:var(--sec); color:var(--text);
      border:1.5px solid transparent; transition:border-color .2s;
    }
    input:focus,select:focus { outline:none; border-color:var(--btn); }

    .screen { display:none; }
    .screen.active { display:block; }

    .nav-tab { transition:all .2s; border-bottom:2px solid transparent; }
    .nav-tab.active { color:var(--btn); border-bottom-color:var(--btn); }

    /* Status pulses */
    @keyframes pg { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.45)}
                    50%{box-shadow:0 0 0 18px rgba(34,197,94,0)} }
    @keyframes pr { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.45)}
                    50%{box-shadow:0 0 0 18px rgba(239,68,68,0)} }
    .pulse-green { animation:pg 2s infinite; }
    .pulse-red   { animation:pr 2s infinite; }

    /* Timeline */
    .slot-power    { background:#fff; border:1px solid #e5e7eb; }
    .slot-no_power { background:#6b7280; }
    .slot-possible { background:#d1d5db; }

    /* Code badge */
    .house-code {
      font-family: 'Courier New', monospace;
      letter-spacing: .12em;
      background: linear-gradient(135deg,#2481cc18,#2481cc08);
      border: 1.5px solid var(--btn);
    }

    /* Toast */
    #toast {
      position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px);
      background:#1a1a1a; color:#fff; padding:10px 20px; border-radius:20px;
      font-size:14px; opacity:0; transition:all .3s; z-index:999; white-space:nowrap;
      pointer-events:none;
    }
    #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

    /* Shimmer loading */
    @keyframes shimmer { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
    .shimmer {
      background:linear-gradient(90deg,var(--sec) 25%,#e2e8f022 50%,var(--sec) 75%);
      background-size:800px 100%; animation:shimmer 1.5s infinite;
      border-radius:12px; height:20px;
    }
  </style>
</head>
<body class="min-h-screen pb-24">

<!-- â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="nav" class="fixed bottom-0 left-0 right-0 tg-sec border-t border-gray-200/50 flex z-50"
     style="display:none!important">
  <button onclick="go('dashboard')" id="tab-dashboard"
    class="nav-tab flex-1 py-2.5 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">âš¡</span>ĞœĞ¾Ğ½Ñ–Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
  </button>
  <button onclick="go('schedule')" id="tab-schedule"
    class="nav-tab flex-1 py-2.5 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">ğŸ“…</span>Ğ“Ñ€Ğ°Ñ„Ñ–Ğº
  </button>
  <button onclick="go('sensor')" id="tab-sensor"
    class="nav-tab flex-1 py-2.5 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">ğŸ“±</span>Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº
  </button>
  <button onclick="go('settings')" id="tab-settings"
    class="nav-tab flex-1 py-2.5 flex flex-col items-center gap-0.5 text-xs font-medium">
    <span class="text-xl">âš™ï¸</span>ĞĞ°Ğ»Ğ°Ñˆ.
  </button>
</nav>

<!-- â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loading" class="fixed inset-0 flex items-center justify-center z-50"
     style="background:var(--bg)">
  <div class="text-center">
    <div class="text-5xl mb-3 animate-bounce">âš¡</div>
    <div class="font-medium">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” REGISTRATION
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-registration" class="screen active px-4 py-6">
  <div class="text-center mb-8">
    <div class="text-5xl mb-3">âš¡</div>
    <h1 class="text-2xl font-bold">Ğ“Ñ€Ğ°Ñ„Ñ–ĞºĞ¸ Ğ²Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ÑŒ</h1>
    <p class="tg-hint text-sm mt-1">DTEK ĞœĞ¾Ğ½Ñ–Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³</p>
  </div>

  <!-- Tab switcher -->
  <div class="flex tg-sec rounded-2xl p-1 mb-6 gap-1">
    <button id="reg-tab-new" onclick="switchRegTab('new')"
      class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all tg-btn">
      ğŸ  ĞĞ¾Ğ²Ğ° Ğ°Ğ´Ñ€ĞµÑĞ°
    </button>
    <button id="reg-tab-join" onclick="switchRegTab('join')"
      class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all tg-hint">
      ğŸ”— Ğ„ ĞºĞ¾Ğ´ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ
    </button>
  </div>

  <!-- NEW ADDRESS form -->
  <div id="reg-form-new" class="max-w-sm mx-auto space-y-3">
    <div>
      <label class="block text-xs font-semibold mb-1 tg-hint uppercase tracking-wide">ğŸ™ï¸ ĞœÑ–ÑÑ‚Ğ¾</label>
      <input id="reg-city" type="text" placeholder="ĞšĞ¸Ñ—Ğ²" list="city-list"
        class="w-full rounded-xl px-4 py-3 text-base"/>
      <datalist id="city-list">
        <option value="ĞšĞ¸Ñ—Ğ²"/><option value="Ğ”Ğ½Ñ–Ğ¿Ñ€Ğ¾"/><option value="ĞĞ´ĞµÑĞ°"/>
        <option value="Ğ¥Ğ°Ñ€ĞºÑ–Ğ²"/><option value="Ğ—Ğ°Ğ¿Ğ¾Ñ€Ñ–Ğ¶Ğ¶Ñ"/><option value="ĞšÑ€Ğ¸Ğ²Ğ¸Ğ¹ Ğ Ñ–Ğ³"/>
        <option value="Ğ¥ĞµÑ€ÑĞ¾Ğ½"/><option value="ĞœĞ¸ĞºĞ¾Ğ»Ğ°Ñ—Ğ²"/><option value="Ğ’Ñ–Ğ½Ğ½Ğ¸Ñ†Ñ"/>
        <option value="ĞŸĞ¾Ğ»Ñ‚Ğ°Ğ²Ğ°"/><option value="Ğ§ĞµÑ€ĞºĞ°ÑĞ¸"/>
      </datalist>
    </div>
    <div>
      <label class="block text-xs font-semibold mb-1 tg-hint uppercase tracking-wide">ğŸ›£ï¸ Ğ’ÑƒĞ»Ğ¸Ñ†Ñ</label>
      <input id="reg-street" type="text" placeholder="Ğ²ÑƒĞ». Ğ¥Ñ€ĞµÑ‰Ğ°Ñ‚Ğ¸Ğº"
        class="w-full rounded-xl px-4 py-3 text-base"/>
    </div>
    <div class="flex gap-3">
      <div class="flex-1">
        <label class="block text-xs font-semibold mb-1 tg-hint uppercase tracking-wide">ğŸ  Ğ‘ÑƒĞ´Ğ¸Ğ½Ğ¾Ğº</label>
        <input id="reg-house" type="text" placeholder="12Ğ"
          class="w-full rounded-xl px-4 py-3 text-base"/>
      </div>
      <div class="flex-1">
        <label class="block text-xs font-semibold mb-1 tg-hint uppercase tracking-wide">ğŸ‘¥ Ğ“Ñ€ÑƒĞ¿Ğ°</label>
        <select id="reg-group" class="w-full rounded-xl px-4 py-3 text-base">
          <option value="">ĞĞ±Ñ€Ğ°Ñ‚Ğ¸</option>
          <option value="1">Ğ“Ñ€ÑƒĞ¿Ğ° 1</option><option value="2">Ğ“Ñ€ÑƒĞ¿Ğ° 2</option>
          <option value="3">Ğ“Ñ€ÑƒĞ¿Ğ° 3</option><option value="4">Ğ“Ñ€ÑƒĞ¿Ğ° 4</option>
          <option value="5">Ğ“Ñ€ÑƒĞ¿Ğ° 5</option><option value="6">Ğ“Ñ€ÑƒĞ¿Ğ° 6</option>
        </select>
      </div>
    </div>
    <div class="tg-sec rounded-xl p-3 text-xs tg-hint">
      ğŸ’¡ Ğ“Ñ€ÑƒĞ¿Ñƒ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ñ–Ğ·Ğ½Ğ°Ñ‚Ğ¸ÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ñ– DTEK Ğ°Ğ±Ğ¾ Ğ² ĞºĞ²Ğ¸Ñ‚Ğ°Ğ½Ñ†Ñ–Ñ— Ğ·Ğ° ĞºĞ¾Ğ¼ÑƒĞ½Ğ°Ğ»ÑŒĞ½Ñ– Ğ¿Ğ¾ÑĞ»ÑƒĞ³Ğ¸.
    </div>
    <button onclick="registerHouse()"
      class="tg-btn w-full py-4 rounded-2xl font-bold text-base mt-2">
      Ğ—Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ°Ğ´Ñ€ĞµÑÑƒ â†’
    </button>
  </div>

  <!-- JOIN form -->
  <div id="reg-form-join" class="max-w-sm mx-auto space-y-4 hidden">
    <p class="tg-hint text-sm text-center">
      Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ 6-ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»ÑŒĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ´ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ, ÑĞºĞ¸Ğ¼ Ğ¿Ğ¾Ğ´Ñ–Ğ»Ğ¸Ğ»Ğ¸ÑÑŒ ÑÑƒÑÑ–Ğ´Ğ¸
    </p>
    <input id="join-code-input" type="text" placeholder="AB3X7K"
      maxlength="6"
      class="w-full rounded-xl px-4 py-4 text-2xl text-center font-mono font-bold tracking-widest uppercase"
      oninput="this.value=this.value.toUpperCase(); previewJoin(this.value)"/>

    <!-- Preview card -->
    <div id="join-preview" class="hidden tg-sec rounded-2xl p-4 text-sm">
      <div class="font-semibold mb-1" id="join-preview-addr">â€”</div>
      <div class="tg-hint text-xs" id="join-preview-group">â€”</div>
      <div class="tg-hint text-xs" id="join-preview-neighbors">â€”</div>
    </div>
    <div id="join-preview-err" class="hidden text-center text-red-400 text-sm py-2"></div>

    <button onclick="joinHouseReg()"
      class="tg-btn w-full py-4 rounded-2xl font-bold text-base">
      ğŸ”— ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑ
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” DASHBOARD
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-dashboard" class="screen px-4 py-4">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="font-bold text-lg">ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½</h2>
      <p class="tg-hint text-xs truncate max-w-[200px]" id="dash-address">â€”</p>
    </div>
    <div class="flex items-center gap-2">
      <!-- House code badge -->
      <span id="dash-code" class="house-code text-xs font-bold px-2.5 py-1 rounded-lg"></span>
      <button onclick="refreshDashboard()" class="tg-hint text-2xl leading-none">â†»</button>
    </div>
  </div>

  <!-- BIG STATUS CARD -->
  <div id="status-card" class="rounded-3xl p-6 mb-4 text-center"
    style="background:linear-gradient(135deg,#f0fdf4,#dcfce7)">
    <div id="status-circle"
      class="w-32 h-32 rounded-full mx-auto mb-4 flex items-center justify-center text-6xl pulse-green"
      style="background:#22c55e">ğŸ’¡</div>
    <div id="status-label" class="text-2xl font-bold text-green-700">Ğ¡Ğ²Ñ–Ñ‚Ğ»Ğ¾ Ñ”</div>
    <div id="status-sub" class="text-sm mt-1 text-green-600">Ğ•Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ñ‡Ğ°Ğ½Ğ½Ñ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ñ–</div>
  </div>

  <!-- INFO ROW -->
  <div class="grid grid-cols-3 gap-2 mb-3">
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5" id="sensor-icon">ğŸ“¡</div>
      <div class="text-xs font-semibold">Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº</div>
      <div class="text-xs tg-hint mt-0.5 leading-tight" id="sensor-online-label">â€”</div>
    </div>
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5">ğŸ‘¥</div>
      <div class="text-xs font-semibold" id="dash-group">Ğ“Ñ€ÑƒĞ¿Ğ° â€”</div>
      <div class="text-xs tg-hint mt-0.5" id="dash-neighbors">â€” Ğ¼ĞµÑˆĞº.</div>
    </div>
    <div class="tg-sec rounded-2xl p-3 text-center">
      <div class="text-2xl mb-0.5">ğŸ”‹</div>
      <div class="text-xs font-semibold" id="sensor-battery">â€”%</div>
      <div class="text-xs tg-hint mt-0.5">Ğ°ĞºÑƒĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€</div>
    </div>
  </div>

  <!-- NEXT EVENT -->
  <div id="next-event-card" class="rounded-2xl p-4 mb-3 border-l-4 border-blue-400"
    style="background:rgba(59,130,246,.06)">
    <div class="text-xs tg-hint font-semibold mb-1 uppercase tracking-wide">ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ¿Ğ¾Ğ´Ñ–Ñ</div>
    <div id="next-event-text" class="font-semibold">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
    <div id="next-event-time" class="text-xs tg-hint mt-0.5"></div>
  </div>

  <!-- SHARE BUTTON -->
  <button onclick="shareHouseCode()"
    class="w-full tg-sec rounded-2xl py-3 text-sm font-medium tg-link border border-blue-200/50">
    ğŸ”— ĞŸĞ¾Ğ´Ñ–Ğ»Ğ¸Ñ‚Ğ¸ÑÑŒ ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ Ğ· ÑÑƒÑÑ–Ğ´Ğ°Ğ¼Ğ¸
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” SCHEDULE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-schedule" class="screen px-4 py-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-bold text-lg">ğŸ“… Ğ“Ñ€Ğ°Ñ„Ñ–Ğº Ğ½Ğ° ÑÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–</h2>
    <span class="tg-hint text-xs" id="sched-date"></span>
  </div>

  <div class="tg-sec rounded-2xl p-3 mb-4">
    <div class="text-xs tg-hint mb-2 font-semibold uppercase tracking-wide">
      Ğ“Ñ€ÑƒĞ¿Ğ° DTEK: <span id="sched-group" class="text-base font-bold" style="color:var(--text)">â€”</span>
    </div>
    <div class="flex gap-4 text-xs flex-wrap">
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-power"></div>Ğ¡Ğ²Ñ–Ñ‚Ğ»Ğ¾ Ñ”</div>
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-no_power"></div>Ğ’Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ</div>
      <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded slot-possible"></div>ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ñ”</div>
    </div>
  </div>

  <!-- Timeline grid 24 cols -->
  <div class="mb-1 flex justify-between text-xs tg-hint px-0.5">
    <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span>
  </div>
  <div id="timeline-grid" class="grid gap-0.5 mb-4 rounded-xl overflow-hidden"
    style="grid-template-columns:repeat(24,1fr)"></div>

  <div id="hourly-list" class="space-y-1"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” SENSOR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-sensor" class="screen px-4 py-4">
  <div class="text-center mb-5">
    <div class="text-5xl mb-2">ğŸ“±</div>
    <h2 class="text-xl font-bold">Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑĞµĞ»Ñ–</h2>
    <p class="tg-hint text-sm mt-1">Ğ¡Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ ÑĞº ÑĞµĞ½ÑĞ¾Ñ€ Ğ¶Ğ¸Ğ²Ğ»ĞµĞ½Ğ½Ñ</p>
  </div>

  <!-- Current sensor status -->
  <div id="sensor-card" class="tg-sec rounded-2xl p-4 mb-4">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">ğŸ“¡ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ´Ğ°Ñ‚Ñ‡Ğ¸ĞºĞ°</span>
      <span id="sensor-badge" class="text-xs px-2 py-0.5 rounded-full font-medium
        bg-gray-200 tg-hint">ĞĞµĞ¼Ğ°Ñ” Ğ´Ğ°Ğ½Ğ¸Ñ…</span>
    </div>
    <div id="sensor-detail" class="text-xs tg-hint space-y-0.5">
      <div>Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğµ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾</div>
    </div>
  </div>

  <!-- House code display -->
  <div class="tg-sec rounded-2xl p-4 mb-4">
    <div class="text-xs tg-hint font-semibold uppercase tracking-wide mb-2">ĞšĞ¾Ğ´ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ</div>
    <div class="flex items-center gap-3">
      <span id="sensor-house-code" class="house-code text-2xl font-bold px-4 py-2 rounded-xl">â€”â€”â€”â€”â€”â€”</span>
      <button onclick="copyHouseCode()" class="tg-link text-sm font-medium">ğŸ“‹ ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸</button>
    </div>
    <p class="text-xs tg-hint mt-2">ĞŸĞ¾Ğ´Ñ–Ğ»Ñ–Ñ‚ÑŒÑÑ ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ· ÑÑƒÑÑ–Ğ´Ğ°Ğ¼Ğ¸ â€” Ğ²Ğ¾Ğ½Ğ¸ Ğ·Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑŒ</p>
  </div>

  <!-- Steps -->
  <div class="tg-sec rounded-2xl p-4 mb-4">
    <div class="font-semibold text-sm mb-3">ğŸ“‹ Ğ¯Ğº Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ´Ğ°Ñ‚Ñ‡Ğ¸Ğº</div>
    <div class="space-y-2.5 text-sm">
      <div class="flex gap-3 items-start">
        <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
        <span>Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ <b>Termux</b> Ğ· <span class="tg-link">F-Droid</span></span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
        <span>Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ¹Ñ‚Ğµ: <code class="text-xs bg-black/10 px-1 rounded">pkg install python termux-api</code></span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
        <span>ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ¹Ñ‚Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ â€” Ğ²Ğ°Ñˆ House ID Ğ²Ğ¶Ğµ Ğ²Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾!</span>
      </div>
      <div class="flex gap-3 items-start">
        <span class="tg-btn rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
        <span>Ğ—Ğ°Ğ»Ğ¸ÑˆÑ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ½Ğ° Ğ·Ğ°Ñ€ÑĞ´Ñ†Ñ– Ğ²Ğ´Ğ¾Ğ¼Ğ°</span>
      </div>
    </div>
  </div>

  <button onclick="requestSensorScript()"
    class="tg-btn w-full py-4 rounded-2xl font-bold text-base">
    ğŸ“¥ ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ñƒ Telegram
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5 â€” SETTINGS (Edit house)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-settings" class="screen px-4 py-4">
  <h2 class="font-bold text-lg mb-4">âš™ï¸ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¾ÑĞµĞ»Ñ–</h2>

  <!-- House list with edit -->
  <div id="settings-houses" class="space-y-3 mb-6"></div>

  <!-- JOIN another house -->
  <div class="tg-sec rounded-2xl p-4 mb-3">
    <div class="font-semibold text-sm mb-3">ğŸ”— ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑ Ğ´Ğ¾ Ñ–Ğ½ÑˆĞ¾Ğ³Ğ¾ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ</div>
    <div class="flex gap-2">
      <input id="settings-join-code" type="text" placeholder="AB3X7K"
        maxlength="6"
        class="flex-1 rounded-xl px-3 py-3 text-center font-mono font-bold text-lg tracking-widest uppercase"
        oninput="this.value=this.value.toUpperCase()"/>
      <button onclick="joinFromSettings()"
        class="tg-btn px-4 rounded-xl font-semibold text-sm">
        ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑŒ
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDIT MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="edit-modal" class="fixed inset-0 z-40 hidden flex items-end justify-center"
     style="background:rgba(0,0,0,.4)" onclick="closeEditModal(event)">
  <div class="w-full max-w-md rounded-t-3xl p-5 pb-8" style="background:var(--bg)" onclick.stop>
    <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
    <h3 class="font-bold text-lg mb-4">âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¾ÑĞµĞ»Ñ</h3>
    <input type="hidden" id="edit-house-id"/>
    <div class="space-y-3">
      <input id="edit-city"   type="text" placeholder="ĞœÑ–ÑÑ‚Ğ¾"   class="w-full rounded-xl px-4 py-3"/>
      <input id="edit-street" type="text" placeholder="Ğ’ÑƒĞ»Ğ¸Ñ†Ñ"  class="w-full rounded-xl px-4 py-3"/>
      <input id="edit-house"  type="text" placeholder="Ğ‘ÑƒĞ´Ğ¸Ğ½Ğ¾Ğº" class="w-full rounded-xl px-4 py-3"/>
      <select id="edit-group" class="w-full rounded-xl px-4 py-3">
        <option value="1">Ğ“Ñ€ÑƒĞ¿Ğ° 1</option><option value="2">Ğ“Ñ€ÑƒĞ¿Ğ° 2</option>
        <option value="3">Ğ“Ñ€ÑƒĞ¿Ğ° 3</option><option value="4">Ğ“Ñ€ÑƒĞ¿Ğ° 4</option>
        <option value="5">Ğ“Ñ€ÑƒĞ¿Ğ° 5</option><option value="6">Ğ“Ñ€ÑƒĞ¿Ğ° 6</option>
      </select>
    </div>
    <button onclick="saveEdit()"
      class="tg-btn w-full py-4 rounded-2xl font-bold text-base mt-4">
      ğŸ’¾ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸
    </button>
  </div>
</div>


<script>
// â•â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000/api' : '/api';

// â•â•â•â• TG INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tg = window.Telegram?.WebApp;
let tgUser = null;
if (tg) {
  tg.ready(); tg.expand();
  tgUser = tg.initDataUnsafe?.user;
  const tp = tg.themeParams || {};
  const set = (v, d) => v || d;
  document.documentElement.style.cssText += `
    --bg:${set(tp.bg_color,'#fff')};
    --text:${set(tp.text_color,'#1a1a1a')};
    --hint:${set(tp.hint_color,'#666')};
    --link:${set(tp.link_color,'#2481cc')};
    --btn:${set(tp.button_color,'#2481cc')};
    --btnT:${set(tp.button_text_color,'#fff')};
    --sec:${set(tp.secondary_bg_color,'#f1f1f1')};
  `;
}

// â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = { house: null, schedule: null, allHouses: [] };

// â•â•â•â• ROUTING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + screen)?.classList.add('active');
  document.getElementById('tab-' + screen)?.classList.add('active');
  if (screen === 'dashboard') refreshDashboard();
  if (screen === 'schedule')  loadSchedule();
  if (screen === 'sensor')    loadSensorScreen();
  if (screen === 'settings')  loadSettings();
}

function showNav() {
  const n = document.getElementById('nav');
  n.style.cssText = 'display:flex!important';
}

// â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const saved = localStorage.getItem('dtek_house_v2');
  if (saved) {
    S.house = JSON.parse(saved);
    showNav(); go('dashboard');
    hideLoading(); return;
  }
  if (tgUser) {
    try {
      const r = await api(`/houses/user/${tgUser.id}`);
      if (r?.houses?.length) {
        S.house = r.houses[0];
        S.allHouses = r.houses;
        save(); showNav(); go('dashboard');
        hideLoading(); return;
      }
    } catch(_) {}
  }
  hideLoading();
  document.getElementById('screen-registration').classList.add('active');
}
function hideLoading() { document.getElementById('loading').style.display = 'none'; }
function save() { localStorage.setItem('dtek_house_v2', JSON.stringify(S.house)); }

// â•â•â•â• API HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path, opts = {}) {
  const r = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json' }, ...opts
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.statusText); }
  return r.json();
}

// â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastT;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(_toastT);
  _toastT = setTimeout(() => el.classList.remove('show'), 2500);
}

// â•â•â•â• REGISTRATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchRegTab(tab) {
  const isNew = tab === 'new';
  document.getElementById('reg-form-new').classList.toggle('hidden', !isNew);
  document.getElementById('reg-form-join').classList.toggle('hidden', isNew);
  const tn = document.getElementById('reg-tab-new');
  const tj = document.getElementById('reg-tab-join');
  if (isNew) {
    tn.className = tn.className.replace('tg-hint','tg-btn');
    tj.className = tj.className.replace('tg-btn','tg-hint');
  } else {
    tj.className = tj.className.replace('tg-hint','tg-btn');
    tn.className = tn.className.replace('tg-btn','tg-hint');
  }
}

async function registerHouse() {
  const city   = document.getElementById('reg-city').value.trim();
  const street = document.getElementById('reg-street').value.trim();
  const house  = document.getElementById('reg-house').value.trim();
  const group  = document.getElementById('reg-group').value;
  if (!city||!street||!house||!group) { toast('âš ï¸ Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ ÑƒÑÑ– Ğ¿Ğ¾Ğ»Ñ'); return; }

  // Register user
  if (tgUser) {
    await api('/users/register', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name
    })}).catch(()=>{});
  }

  try {
    const data = await api('/houses/add', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser?.id || 0,
      city, street, house_number: house, dtek_group: parseInt(group)
    })});
    S.house = data; save();
  } catch(_) {
    S.house = { id:1, house_code:'DEMO01', city, street, house_number:house, dtek_group:parseInt(group), neighbors_count:1 };
    save();
  }
  showNav(); go('dashboard');
}

// â”€â”€â”€ Join preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _joinTimer;
async function previewJoin(code) {
  clearTimeout(_joinTimer);
  document.getElementById('join-preview').classList.add('hidden');
  document.getElementById('join-preview-err').classList.add('hidden');
  if (code.length !== 6) return;
  _joinTimer = setTimeout(async () => {
    try {
      const d = await api(`/houses/code/${code}`);
      document.getElementById('join-preview-addr').textContent =
        `${d.city}, ${d.street}, Ğ±ÑƒĞ´. ${d.house_number}`;
      document.getElementById('join-preview-group').textContent = `Ğ“Ñ€ÑƒĞ¿Ğ° DTEK: ${d.dtek_group}`;
      document.getElementById('join-preview-neighbors').textContent =
        `ğŸ‘¤ ${d.neighbors_count} Ğ¼ĞµÑˆĞºĞ°Ğ½Ñ†Ñ–Ğ² ÑÑ‚ĞµĞ¶Ğ°Ñ‚ÑŒ`;
      document.getElementById('join-preview').classList.remove('hidden');
    } catch(e) {
      document.getElementById('join-preview-err').textContent = `âŒ ${e.message}`;
      document.getElementById('join-preview-err').classList.remove('hidden');
    }
  }, 400);
}

async function joinHouseReg() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (code.length !== 6) { toast('âš ï¸ Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ 6-ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»ÑŒĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ´'); return; }
  if (tgUser) {
    await api('/users/register', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser.id, username: tgUser.username, first_name: tgUser.first_name
    })}).catch(()=>{});
  }
  try {
    const d = await api('/houses/join', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser?.id || 0, house_code: code
    })});
    S.house = d; save();
    toast(d.already_joined ? 'â„¹ï¸ Ğ’Ğ¶Ğµ Ğ¿Ñ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ğ½Ğ¾' : 'âœ… Ğ£ÑĞ¿Ñ–ÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ğ½Ğ¾!');
    showNav(); go('dashboard');
  } catch(e) { toast('âŒ ' + e.message); }
}

// â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshDashboard() {
  if (!S.house) return;
  const h = S.house;
  document.getElementById('dash-address').textContent =
    `${h.city}, ${h.street}, ${h.house_number}`;
  document.getElementById('dash-code').textContent = h.house_code || '';
  document.getElementById('dash-group').textContent = `Ğ“Ñ€ÑƒĞ¿Ğ° ${h.dtek_group}`;
  document.getElementById('dash-neighbors').textContent =
    `${h.neighbors_count ?? 'â€”'} Ğ¼ĞµÑˆĞº.`;

  // Refresh from API
  if (tgUser) {
    try {
      const r = await api(`/houses/user/${tgUser.id}`);
      if (r?.houses?.[0]) {
        S.house = r.houses[0]; S.allHouses = r.houses; save();
        const hf = S.house;
        document.getElementById('dash-neighbors').textContent =
          `${hf.neighbors_count ?? 'â€”'} Ğ¼ĞµÑˆĞº.`;
        updateSensorWidgets(hf.sensor_status);
      }
    } catch(_){}
  }

  // Schedule
  try {
    const sched = await api(`/schedule/${h.dtek_group}`);
    S.schedule = sched;
    updateStatusCard(sched.current_status);
    updateNextEvent(sched.next_event);
  } catch(_) {
    updateStatusCard('power');
  }
}

function updateSensorWidgets(sensor) {
  if (!sensor) {
    document.getElementById('sensor-icon').textContent = 'âšª';
    document.getElementById('sensor-online-label').textContent = 'ĞĞµ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾';
    document.getElementById('sensor-battery').textContent = 'â€”%';
    return;
  }
  const online = sensor.online;
  document.getElementById('sensor-icon').textContent = sensor.is_charging ? (online?'ğŸŸ¢':'ğŸŸ¡') : (online?'ğŸ”´':'âšª');
  document.getElementById('sensor-online-label').textContent = sensor.online_label || 'â€”';
  document.getElementById('sensor-battery').textContent =
    sensor.battery_percentage != null ? sensor.battery_percentage + '%' : 'â€”%';
}

function updateStatusCard(status) {
  const circle = document.getElementById('status-circle');
  const label  = document.getElementById('status-label');
  const sub    = document.getElementById('status-sub');
  const card   = document.getElementById('status-card');
  if (status === 'power') {
    circle.style.background = '#22c55e';
    circle.className = circle.className.replace('pulse-red','pulse-green');
    circle.textContent = 'ğŸ’¡';
    label.textContent = 'Ğ¡Ğ²Ñ–Ñ‚Ğ»Ğ¾ Ñ”'; label.className = 'text-2xl font-bold text-green-700';
    sub.textContent = 'Ğ•Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ñ‡Ğ°Ğ½Ğ½Ñ Ğ² Ğ½Ğ¾Ñ€Ğ¼Ñ–'; sub.className = 'text-sm mt-1 text-green-600';
    card.style.background = 'linear-gradient(135deg,#f0fdf4,#dcfce7)';
  } else {
    circle.style.background = '#ef4444';
    circle.className = circle.className.replace('pulse-green','pulse-red');
    circle.textContent = 'ğŸ”´';
    label.textContent = 'Ğ’Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ'; label.className = 'text-2xl font-bold text-red-700';
    sub.textContent = 'Ğ•Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ñ‡Ğ°Ğ½Ğ½Ñ Ğ²Ñ–Ğ´ÑÑƒÑ‚Ğ½Ñ”'; sub.className = 'text-sm mt-1 text-red-500';
    card.style.background = 'linear-gradient(135deg,#fef2f2,#fee2e2)';
  }
}

function updateNextEvent(ev) {
  if (!ev) { document.getElementById('next-event-text').textContent = 'Ğ”Ğ°Ğ½Ñ– Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ–'; return; }
  document.getElementById('next-event-text').textContent = ev.label;
  document.getElementById('next-event-time').textContent =
    `Ğ ${ev.time} (Ñ‡ĞµÑ€ĞµĞ· ${ev.in_hours} Ğ³Ğ¾Ğ´.)`;
}

function shareHouseCode() {
  const code = S.house?.house_code;
  if (!code) return;
  const msg = `ğŸ  ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ğ¹ÑÑ Ğ´Ğ¾ Ğ¼Ğ¾Ğ½Ñ–Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ñƒ Ğ²Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ÑŒ!\nĞšĞ¾Ğ´ Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑƒ: ${code}\nĞ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ¹: @dtek_monitor_bot`;
  if (tg?.shareUrl) { tg.shareUrl(msg); }
  else if (navigator.clipboard) { navigator.clipboard.writeText(code); toast('ğŸ“‹ ĞšĞ¾Ğ´ ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾: ' + code); }
}

// â•â•â•â• SCHEDULE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSchedule() {
  if (!S.house) return;
  document.getElementById('sched-group').textContent = S.house.dtek_group;
  document.getElementById('sched-date').textContent =
    new Date().toLocaleDateString('uk-UA', {weekday:'short',day:'numeric',month:'short'});

  let slots;
  try {
    const r = await api(`/schedule/${S.house.dtek_group}`);
    slots = r.slots;
  } catch(_) { slots = mockSlots(S.house.dtek_group); }

  renderTimeline(slots);
  renderHourlyList(slots);
}

function renderTimeline(slots) {
  const now = new Date().getHours();
  document.getElementById('timeline-grid').innerHTML = slots.map(s => `
    <div class="slot-${s.type} relative" style="height:36px;${s.hour===now?'outline:2px solid var(--btn);outline-offset:1px':''}"
      title="${s.time_label}: ${s.label}">
    </div>
  `).join('');
}

function renderHourlyList(slots) {
  const now = new Date().getHours();
  const icons = {power:'ğŸ’¡',no_power:'â›”',possible:'ğŸ”†'};
  const colors = {power:'text-green-600',no_power:'text-red-500',possible:'text-yellow-500'};
  document.getElementById('hourly-list').innerHTML = slots.map(s => `
    <div class="flex items-center gap-2 px-3 py-2 rounded-xl text-sm
      ${s.hour===now ? 'border-2 tg-border font-semibold' : 'tg-sec'}">
      <span class="tg-hint w-14 text-xs">${s.time_label.split('â€“')[0]}</span>
      <span class="${colors[s.type]} flex-1">${icons[s.type]} ${s.label}</span>
      ${s.hour===now ? '<span class="text-xs tg-hint">â† Ğ·Ğ°Ñ€Ğ°Ğ·</span>' : ''}
    </div>
  `).join('');
}

function mockSlots(group) {
  const raw = {1:[1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0],
    2:[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,1],
    3:[1,1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0],
    4:[0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,0],
    5:[1,0,0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,1],
    6:[0,0,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0,0]}[group]||[];
  return raw.map((v,h)=>({
    hour:h, time_label:`${String(h).padStart(2,'0')}:00â€“${String((h+1)%24).padStart(2,'0')}:00`,
    type:v?'power':'no_power', label:v?'Ğ¡Ğ²Ñ–Ñ‚Ğ»Ğ¾ Ñ”':'Ğ’Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ'
  }));
}

// â•â•â•â• SENSOR SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSensorScreen() {
  const h = S.house;
  if (!h) return;

  document.getElementById('sensor-house-code').textContent = h.house_code || 'â€”â€”â€”â€”â€”â€”';

  const sensor = h.sensor_status;
  const badge = document.getElementById('sensor-badge');
  const detail = document.getElementById('sensor-detail');

  if (!sensor) {
    badge.textContent = 'ĞĞµĞ¼Ğ°Ñ” Ğ´Ğ°Ğ½Ğ¸Ñ…';
    badge.className = badge.className.replace(/bg-\S+/g,'bg-gray-200');
    detail.innerHTML = '<div>Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğµ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾. ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ¹Ñ‚Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğ¸Ğ¶Ñ‡Ğµ.</div>';
    return;
  }

  const online = sensor.online;
  const charging = sensor.is_charging;

  badge.textContent = sensor.online_label;
  badge.className = badge.className.replace(/bg-\S+\s/g,'')
    + (online ? (charging ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')
              : 'bg-gray-200 text-gray-600');

  const ago = sensor.minutes_ago != null ? ` (${sensor.minutes_ago} Ñ…Ğ² Ñ‚Ğ¾Ğ¼Ñƒ)` : '';
  detail.innerHTML = `
    <div>${charging ? 'ğŸ’¡ Ğ—Ğ°Ñ€ÑĞ´Ğ¶Ğ°Ñ”Ñ‚ÑŒÑÑ â€” <b>Ğ¡Ğ²Ñ–Ñ‚Ğ»Ğ¾ Ñ”</b>' : 'ğŸ”´ Ğ’Ñ–Ğ´ Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµÑ— â€” <b>ĞĞµĞ¼Ğ°Ñ” ÑĞ²Ñ–Ñ‚Ğ»Ğ°</b>'}</div>
    ${sensor.battery_percentage!=null ? `<div>ğŸ”‹ ĞĞºÑƒĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€: ${sensor.battery_percentage}%</div>` : ''}
    <div>â± ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾${ago}</div>
  `;
}

function copyHouseCode() {
  const code = S.house?.house_code;
  if (!code) return;
  navigator.clipboard?.writeText(code).then(()=>toast('ğŸ“‹ ĞšĞ¾Ğ´ ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾: ' + code));
}

async function requestSensorScript() {
  if (!S.house) { toast('âš ï¸ Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ·Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ±ÑƒĞ´Ğ¸Ğ½Ğ¾Ğº'); return; }
  toast('ğŸ“¤ ĞĞ°Ğ´ÑĞ¸Ğ»Ğ°Ñ”Ğ¼Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ñƒ Telegram...');
  try {
    await api(`/sensor/send-script/${tgUser?.id||0}?house_id=${S.house.id}`, {method:'POST'});
    toast('âœ… Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğ°Ğ´Ñ–ÑĞ»Ğ°Ğ½Ğ¾ Ñƒ Telegram!');
  } catch(_) { toast('âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°. ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ñƒ /sensor'); }
}

// â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings() {
  if (tgUser) {
    try {
      const r = await api(`/houses/user/${tgUser.id}`);
      if (r?.houses) { S.allHouses = r.houses; }
    } catch(_) {}
  }

  const houses = S.allHouses.length ? S.allHouses : (S.house ? [S.house] : []);
  const container = document.getElementById('settings-houses');

  container.innerHTML = houses.map(h => {
    const sensor = h.sensor_status;
    const sIcon = sensor ? (sensor.online ? (sensor.is_charging?'ğŸŸ¢':'ğŸ”´') : 'âšª') : 'âšª';
    return `
    <div class="tg-sec rounded-2xl p-4">
      <div class="flex items-start justify-between mb-2">
        <div>
          <div class="font-semibold text-sm">${h.city}, ${h.street}, ${h.house_number}</div>
          <div class="tg-hint text-xs mt-0.5">Ğ“Ñ€ÑƒĞ¿Ğ° ${h.dtek_group} Â· ğŸ‘¤ ${h.neighbors_count} Ğ¼ĞµÑˆĞº.</div>
        </div>
        <button onclick='openEditModal(${JSON.stringify(h)})'
          class="tg-link text-sm font-medium ml-2 flex-shrink-0">âœï¸ Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸</button>
      </div>
      <div class="flex items-center gap-3 mt-2">
        <span class="house-code text-sm font-bold px-2 py-0.5 rounded-lg">${h.house_code}</span>
        <span class="text-xs tg-hint">${sIcon} ${sensor?.online_label||'Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğµ Ğ¿Ñ–Ğ´ĞºĞ».'}</span>
      </div>
    </div>`;
  }).join('') || '<p class="tg-hint text-sm text-center py-4">ĞĞµĞ¼Ğ°Ñ” Ğ±ÑƒĞ´Ğ¸Ğ½ĞºÑ–Ğ²</p>';
}

async function joinFromSettings() {
  const code = document.getElementById('settings-join-code').value.trim().toUpperCase();
  if (code.length !== 6) { toast('âš ï¸ Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²'); return; }
  try {
    const d = await api('/houses/join', { method:'POST', body: JSON.stringify({
      telegram_id: tgUser?.id||0, house_code: code
    })});
    toast(d.already_joined ? 'â„¹ï¸ Ğ’Ğ¶Ğµ Ğ¿Ñ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ğ½Ğ¾' : 'âœ… ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ğ½Ğ¾ Ğ´Ğ¾ ' + d.city);
    S.house = d; save();
    document.getElementById('settings-join-code').value = '';
    loadSettings();
  } catch(e) { toast('âŒ ' + e.message); }
}

// â”€â”€â”€ Edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditModal(h) {
  document.getElementById('edit-house-id').value  = h.id;
  document.getElementById('edit-city').value   = h.city;
  document.getElementById('edit-street').value = h.street;
  document.getElementById('edit-house').value  = h.house_number;
  document.getElementById('edit-group').value  = h.dtek_group;
  document.getElementById('edit-modal').classList.remove('hidden');
}
function closeEditModal(e) {
  if (e.target === document.getElementById('edit-modal'))
    document.getElementById('edit-modal').classList.add('hidden');
}

async function saveEdit() {
  const id = parseInt(document.getElementById('edit-house-id').value);
  const body = {
    telegram_id:  tgUser?.id || 0,
    house_id:     id,
    city:         document.getElementById('edit-city').value.trim(),
    street:       document.getElementById('edit-street').value.trim(),
    house_number: document.getElementById('edit-house').value.trim(),
    dtek_group:   parseInt(document.getElementById('edit-group').value),
  };
  try {
    const d = await api('/houses/edit', { method:'PATCH', body: JSON.stringify(body) });
    toast('âœ… Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾');
    if (S.house?.id === id) { S.house = d; save(); }
    S.allHouses = S.allHouses.map(h => h.id === id ? d : h);
    document.getElementById('edit-modal').classList.add('hidden');
    loadSettings();
  } catch(e) { toast('âŒ ' + e.message); }
}

// â•â•â•â• START â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
