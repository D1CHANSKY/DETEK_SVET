<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PowerWatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-bg:        var(--tg-theme-bg-color, #17212b);
      --tg-text:      var(--tg-theme-text-color, #f5f5f5);
      --tg-hint:      var(--tg-theme-hint-color, #708499);
      --tg-link:      var(--tg-theme-link-color, #5eadeb);
      --tg-btn:       var(--tg-theme-button-color, #5eadeb);
      --tg-btn-text:  var(--tg-theme-button-text-color, #ffffff);
      --tg-secondary: var(--tg-theme-secondary-bg-color, #232e3c);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--tg-bg);
      color: var(--tg-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
    }

    .card {
      background-color: var(--tg-secondary);
      border-radius: 16px;
      padding: 20px;
    }

    .hint { color: var(--tg-hint); }
    .link { color: var(--tg-link); }

    .btn {
      background-color: var(--tg-btn);
      color: var(--tg-btn-text);
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn:active { opacity: 0.7; }
    .btn-secondary {
      background-color: transparent;
      border: 2px solid var(--tg-btn);
      color: var(--tg-link);
    }

    /* Power indicator */
    .power-ring {
      width: 160px; height: 160px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      position: relative;
      transition: all 0.6s ease;
    }
    .power-ring.on {
      background: radial-gradient(circle, rgba(72,199,116,0.25) 0%, rgba(72,199,116,0.05) 70%);
      box-shadow: 0 0 0 8px rgba(72,199,116,0.15), 0 0 40px rgba(72,199,116,0.3);
      border: 3px solid #48c774;
    }
    .power-ring.off {
      background: radial-gradient(circle, rgba(255,77,77,0.25) 0%, rgba(255,77,77,0.05) 70%);
      box-shadow: 0 0 0 8px rgba(255,77,77,0.15), 0 0 40px rgba(255,77,77,0.25);
      border: 3px solid #ff4d4d;
    }
    .power-ring.unknown {
      border: 3px solid var(--tg-hint);
      box-shadow: none;
    }

    /* Timeline */
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .timeline-item:last-child { border-bottom: none; }
    .dot {
      width: 12px; height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }
    .dot.on  { background: #48c774; }
    .dot.off { background: #ff4d4d; }

    /* Tabs */
    .tab {
      flex: 1; padding: 10px; text-align: center;
      border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 14px;
      transition: background 0.2s;
      color: var(--tg-hint);
    }
    .tab.active {
      background-color: var(--tg-btn);
      color: var(--tg-btn-text);
    }

    /* Input */
    .tg-input {
      background: var(--tg-bg);
      border: 1.5px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 16px;
      color: var(--tg-text);
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
    }
    .tg-input:focus { border-color: var(--tg-btn); }
    .tg-input::placeholder { color: var(--tg-hint); }

    /* Copy badge */
    .copy-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--tg-bg);
      border: 1.5px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 10px 16px;
      font-family: monospace;
      font-size: 18px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .copy-badge:active { border-color: var(--tg-btn); }

    /* Pulse animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .pulse { animation: pulse 2s infinite; }

    /* Toast */
    #toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff;
      padding: 10px 20px; border-radius: 20px;
      font-size: 14px; opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none; z-index: 999;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<div id="toast"></div>

<!-- ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ -->
<div id="app" class="max-w-md mx-auto px-4 py-6 space-y-4">

  <!-- Setup screen (no house linked) -->
  <div id="screen-setup" class="hidden space-y-4">
    <div class="text-center pt-8 pb-2">
      <div class="text-4xl mb-2">‚ö°</div>
      <h1 class="text-2xl font-bold">PowerWatch</h1>
      <p class="hint text-sm mt-1">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–∏–∫–∏</p>
    </div>

    <!-- Tabs -->
    <div id="setup-tabs" class="flex gap-2 card">
      <div class="tab active" onclick="switchSetupTab('create')">–°—Ç–≤–æ—Ä–∏—Ç–∏</div>
      <div class="tab" onclick="switchSetupTab('join')">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</div>
    </div>

    <!-- Create -->
    <div id="tab-create" class="card space-y-3">
      <p class="text-sm hint">–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞—à–æ–≥–æ –±—É–¥–∏–Ω–∫—É –∞–±–æ –∫–≤–∞—Ä—Ç–∏—Ä–∏</p>
      <input id="house-name-input" class="tg-input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–≤–∞—Ä—Ç–∏—Ä–∞ 47" maxlength="64" />
      <button class="btn" onclick="createHouse()">üè† –°—Ç–≤–æ—Ä–∏—Ç–∏ –±—É–¥–∏–Ω–æ–∫</button>
    </div>

    <!-- Join -->
    <div id="tab-join" class="card space-y-3 hidden">
      <p class="text-sm hint">–í–≤–µ–¥—ñ—Ç—å ID –±—É–¥–∏–Ω–∫—É, —è–∫–∏–º –ø–æ–¥—ñ–ª–∏–ª–∏—Å—å —Å—É—Å—ñ–¥–∏</p>
      <input id="house-id-input" class="tg-input" placeholder="HOME-1234" maxlength="9"
             oninput="this.value=this.value.toUpperCase()" />
      <button class="btn" onclick="joinHouse()">üîë –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
    </div>
  </div>

  <!-- Main dashboard -->
  <div id="screen-main" class="hidden space-y-4">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-lg font-bold" id="house-name-display">–ë—É–¥–∏–Ω–æ–∫</h1>
        <p class="hint text-xs" id="last-updated-display">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</p>
      </div>
      <button class="btn-secondary btn w-auto px-4 py-2 text-sm" onclick="refreshStatus()">‚Üª</button>
    </div>

    <!-- Power indicator -->
    <div class="card flex flex-col items-center py-8 space-y-4">
      <div id="power-ring" class="power-ring unknown">
        <div id="power-icon" class="text-5xl">‚ö°</div>
        <div id="power-label" class="text-sm font-semibold mt-2 hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      </div>
      <p id="power-since" class="text-xs hint text-center"></p>
    </div>

    <!-- House ID share -->
    <div class="card space-y-2">
      <p class="text-sm hint">ID –±—É–¥–∏–Ω–∫—É –¥–ª—è —Å—É—Å—ñ–¥—ñ–≤:</p>
      <div class="copy-badge" onclick="copyHouseId()" id="house-id-badge">
        <span id="house-id-text">‚Äî</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
        </svg>
      </div>
      <p class="text-xs hint">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏</p>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2">
      <div id="tab-history-btn" class="tab active" onclick="switchMainTab('history')">üìã –Ü—Å—Ç–æ—Ä—ñ—è</div>
      <div id="tab-info-btn" class="tab" onclick="switchMainTab('info')">‚ÑπÔ∏è –Ü–Ω—Ñ–æ</div>
    </div>

    <!-- History panel -->
    <div id="panel-history" class="card space-y-1">
      <div id="history-list">
        <p class="hint text-sm text-center py-4">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
      </div>
    </div>

    <!-- Info panel -->
    <div id="panel-info" class="card space-y-4 hidden">
      <h3 class="font-semibold">–Ø–∫ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ —Å–µ–Ω—Å–æ—Ä?</h3>
      <ol class="space-y-3 text-sm" style="list-style: none;">
        <li class="flex gap-3">
          <span class="text-lg">1Ô∏è‚É£</span>
          <span>–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å <strong>Termux</strong> —Ç–∞ <strong>Termux:API</strong> –∑ F-Droid –Ω–∞ —Å—Ç–∞—Ä–∏–π Android.</span>
        </li>
        <li class="flex gap-3">
          <span class="text-lg">2Ô∏è‚É£</span>
          <span>–í–∏–∫–æ–Ω–∞–π—Ç–µ: <code class="bg-black/30 px-1 rounded">pkg install termux-api python</code></span>
        </li>
        <li class="flex gap-3">
          <span class="text-lg">3Ô∏è‚É£</span>
          <span>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ <code class="bg-black/30 px-1 rounded">sensor.py</code>, –≤–∫–∞–∂—ñ—Ç—å –≤–∞—à <strong id="info-house-id">HOME-XXXX</strong> —Ç–∞ URL —Å–µ—Ä–≤–µ—Ä–∞.</span>
        </li>
        <li class="flex gap-3">
          <span class="text-lg">4Ô∏è‚É£</span>
          <span>–ó–∞–ø—É—Å—Ç—ñ—Ç—å: <code class="bg-black/30 px-1 rounded">python sensor.py</code></span>
        </li>
        <li class="flex gap-3">
          <span class="text-lg">5Ô∏è‚É£</span>
          <span>–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ —Ä–æ–∑–µ—Ç–∫–∏ ‚Äî –≤—ñ–Ω —Ñ—ñ–∫—Å—É–≤–∞—Ç–∏–º–µ –ø–æ—è–≤—É/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞.</span>
        </li>
      </ol>
      <div class="pt-2 border-t border-white/10">
        <button class="btn btn-secondary" onclick="leaveHouse()">üö™ –ü–æ–∫–∏–Ω—É—Ç–∏ –±—É–¥–∏–Ω–æ–∫</button>
      </div>
    </div>

  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_BASE = window.location.origin; // same origin
const REFRESH_INTERVAL = 30_000; // ms

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tg = window.Telegram?.WebApp;
let currentHouseId = null;
let refreshTimer = null;

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', async () => {
  if (tg) {
    tg.expand();
    tg.ready();
  }

  const saved = localStorage.getItem('powerwatch_house_id');
  if (saved) {
    currentHouseId = saved;
    showMainScreen();
    await refreshAll();
    startAutoRefresh();
  } else {
    showSetupScreen();
  }
});

// ‚îÄ‚îÄ‚îÄ Screen management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSetupScreen() {
  document.getElementById('screen-setup').classList.remove('hidden');
  document.getElementById('screen-main').classList.add('hidden');
}

function showMainScreen() {
  document.getElementById('screen-setup').classList.add('hidden');
  document.getElementById('screen-main').classList.remove('hidden');
  document.getElementById('house-id-text').textContent = currentHouseId;
  document.getElementById('info-house-id').textContent = currentHouseId;
}

function switchSetupTab(tab) {
  document.querySelectorAll('#setup-tabs .tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0) === (tab === 'create'));
  });
  document.getElementById('tab-create').classList.toggle('hidden', tab !== 'create');
  document.getElementById('tab-join').classList.toggle('hidden', tab !== 'join');
}

function switchMainTab(tab) {
  document.getElementById('tab-history-btn').classList.toggle('active', tab === 'history');
  document.getElementById('tab-info-btn').classList.toggle('active', tab === 'info');
  document.getElementById('panel-history').classList.toggle('hidden', tab !== 'history');
  document.getElementById('panel-info').classList.toggle('hidden', tab !== 'info');
}

// ‚îÄ‚îÄ‚îÄ Create / Join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function createHouse() {
  const name = document.getElementById('house-name-input').value.trim();
  if (!name) return showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –±—É–¥–∏–Ω–∫—É');
  const uid = tg?.initDataUnsafe?.user?.id || 0;
  const username = tg?.initDataUnsafe?.user?.username || null;

  try {
    const r = await fetch(`${API_BASE}/api/house`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: uid, username, house_name: name }),
    });
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();
    currentHouseId = data.house_id;
    localStorage.setItem('powerwatch_house_id', currentHouseId);
    showMainScreen();
    await refreshAll();
    startAutoRefresh();
    showToast(`‚úÖ –ë—É–¥–∏–Ω–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ: ${currentHouseId}`);
  } catch (e) {
    showToast('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message);
  }
}

async function joinHouse() {
  const id = document.getElementById('house-id-input').value.trim().toUpperCase();
  if (!/^HOME-\d{4}$/.test(id)) return showToast('–§–æ—Ä–º–∞—Ç: HOME-1234');
  const uid = tg?.initDataUnsafe?.user?.id || 0;
  const username = tg?.initDataUnsafe?.user?.username || null;

  try {
    const r = await fetch(`${API_BASE}/api/house/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: uid, username, house_id: id }),
    });
    if (!r.ok) {
      const err = await r.json();
      throw new Error(err.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞');
    }
    currentHouseId = id;
    localStorage.setItem('powerwatch_house_id', currentHouseId);
    showMainScreen();
    await refreshAll();
    startAutoRefresh();
    showToast(`‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ ${currentHouseId}`);
  } catch (e) {
    showToast('‚ùå ' + e.message);
  }
}

function leaveHouse() {
  if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–∫–∏–Ω—É—Ç–∏ –±—É–¥–∏–Ω–æ–∫?')) return;
  localStorage.removeItem('powerwatch_house_id');
  currentHouseId = null;
  stopAutoRefresh();
  showSetupScreen();
}

// ‚îÄ‚îÄ‚îÄ Data refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshAll() {
  await Promise.all([refreshStatus(), refreshHistory()]);
}

async function refreshStatus() {
  if (!currentHouseId) return;
  try {
    const r = await fetch(`${API_BASE}/api/house/${currentHouseId}/status`);
    if (!r.ok) { currentHouseId = null; localStorage.removeItem('powerwatch_house_id'); showSetupScreen(); return; }
    const data = await r.json();

    document.getElementById('house-name-display').textContent = data.house_name || currentHouseId;

    const ring  = document.getElementById('power-ring');
    const icon  = document.getElementById('power-icon');
    const label = document.getElementById('power-label');
    const since = document.getElementById('power-since');
    const upd   = document.getElementById('last-updated-display');

    ring.className = 'power-ring ' + (data.current_status ?? 'unknown');

    if (data.current_status === 'on') {
      icon.textContent = 'üí°';
      label.textContent = '–ï–ª–µ–∫—Ç—Ä–∏–∫–∞ —î';
      label.style.color = '#48c774';
    } else if (data.current_status === 'off') {
      icon.textContent = 'üïØÔ∏è';
      label.textContent = '–ï–ª–µ–∫—Ç—Ä–∏–∫–∏ –Ω–µ–º–∞—î';
      label.style.color = '#ff4d4d';
    } else {
      icon.textContent = '‚ö°';
      label.textContent = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö';
      label.style.color = 'var(--tg-hint)';
    }

    if (data.last_updated) {
      const dt = new Date(data.last_updated + 'Z');
      since.textContent = `–ó ${fmtDate(dt)}`;
      upd.textContent   = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${fmtTime(dt)}`;
    } else {
      since.textContent = '';
      upd.textContent   = '–°–µ–Ω—Å–æ—Ä —â–µ –Ω–µ –Ω–∞–¥—Å–∏–ª–∞–≤ –¥–∞–Ω–∏—Ö';
    }
  } catch (e) {
    console.error('Status error', e);
  }
}

async function refreshHistory() {
  if (!currentHouseId) return;
  try {
    const r = await fetch(`${API_BASE}/api/house/${currentHouseId}/history?limit=30`);
    const logs = await r.json();
    const el = document.getElementById('history-list');

    if (!logs.length) {
      el.innerHTML = '<p class="hint text-sm text-center py-4">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è ‚Äî –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å —Å–µ–Ω—Å–æ—Ä</p>';
      return;
    }

    el.innerHTML = logs.map(l => {
      const dt = new Date(l.logged_at + 'Z');
      const label = l.status === 'on' ? '–ï–ª–µ–∫—Ç—Ä–∏–∫–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–∞' : '–ï–ª–µ–∫—Ç—Ä–∏–∫–∞ –≤–∏–º–∫–Ω–µ–Ω–∞';
      return `
        <div class="timeline-item">
          <div class="dot ${l.status}"></div>
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium">${label}</div>
            <div class="hint text-xs">${fmtDate(dt)}</div>
          </div>
        </div>`;
    }).join('');
  } catch (e) {
    console.error('History error', e);
  }
}

function startAutoRefresh() {
  stopAutoRefresh();
  refreshTimer = setInterval(refreshAll, REFRESH_INTERVAL);
}

function stopAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyHouseId() {
  if (!currentHouseId) return;
  navigator.clipboard?.writeText(currentHouseId).then(() => showToast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function fmtDate(dt) {
  return dt.toLocaleString('uk-UA', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit',
  });
}

function fmtTime(dt) {
  return dt.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
}
</script>
</body>
</html>
